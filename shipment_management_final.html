<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Management - Smart Dispatch</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Supabase & jsPDF Clients -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable"></script>
    
    <!-- Phosphor Icons for a clean, modern look -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        [data-theme="dark"] body {
            background-color: #1e293b;
            color: #f1f5f9;
        }
        .sidebar { transition: all 0.3s ease; width: 256px; }
        .sidebar.collapsed { width: 64px; }
        .sidebar-item-text { transition: all 0.3s ease; }
        .sidebar.collapsed .sidebar-item-text { opacity: 0; pointer-events: none; }
        .box-item { transition: all 0.2s ease-in-out; border-left-width: 4px; }
        .box-item:hover { transform: scale(1.03); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .drop-zone { transition: all 0.3s ease; }
        .drop-zone.drag-over { border-style: dashed; border-color: #4f46e5; background-color: #eef2ff; }
        .modal { display: none; }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .toast { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.hide { transform: translateY(100%); opacity: 0; }
        [data-theme="dark"] .bg-slate-50 { background-color: #475569; }
        [data-theme="dark"] .bg-white { background-color: #1f2a3a; color: #f1f5f9; }
        [data-theme="dark"] .bg-indigo-600 { background-color: #4f46e5; }
        [data-theme="dark"] .text-slate-800 { color: #f1f5f9; }
        [data-theme="dark"] .text-slate-900 { color: #e2e8f0; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-white shadow-xl p-4 flex flex-col justify-between">
            <div>
                <div class="flex items-center justify-between mb-8 p-2">
                    <a href="./index.html" class="flex items-center space-x-3">
                        <div class="bg-indigo-600 p-2 rounded-lg shadow">
                            <i class="ph-bold ph-list-dashes text-white text-lg"></i>
                        </div>
                        <span class="text-xl font-extrabold tracking-tight text-slate-900 sidebar-item-text">Smart Dispatch</span>
                    </a>
                    <button id="sidebar-toggle" class="p-1 rounded-md hover:bg-slate-100">
                        <i class="ph-bold ph-caret-left text-slate-400"></i>
                    </button>
                </div>
                <nav>
    <ul class="space-y-2">
        <li>
            <a href="./index.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-house-simple text-lg"></i>
                <span class="sidebar-item-text">Dashboard</span>
            </a>
        </li>
        <li>
            <a href="./daily_dispatch.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-cloud-arrow-up text-lg"></i>
                <span class="sidebar-item-text">Daily Dispatch</span>
            </a>
        </li>
        <li>
            <a href="./packing_station_final_working.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-package text-lg"></i>
                <span class="sidebar-item-text">Packing Station</span>
            </a>
        </li>
        <li>
            <a href="./shipment_management_final.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-truck text-lg"></i>
                <span class="sidebar-item-text">Shipments</span>
            </a>
        </li>
        <li>
            <a href="./docket_generation.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-file-text text-lg"></i>
                <span class="sidebar-item-text">Generate Dockets</span>
            </a>
        </li>
    </ul>
</nav>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-200 flex items-center justify-center">
                            <span class="font-bold text-indigo-800" id="user-initials"></span>
                        </div>
                        <div class="flex flex-col sidebar-item-text">
                            <span class="text-sm font-semibold text-slate-800" id="user-display">Loading...</span>
                            <span class="text-xs text-slate-500" id="user-role-display"></span>
                        </div>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-md hover:bg-slate-200">
                        <i class="ph-bold ph-sign-out text-slate-500 text-lg"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-3 p-2 rounded-lg bg-slate-50 justify-between">
                    <span class="text-xs font-semibold text-slate-600 sidebar-item-text">Dark Mode</span>
                    <button id="theme-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition-colors">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" id="theme-circle"></span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-6 lg:p-8">
            <h1 class="text-3xl font-extrabold text-slate-900 mb-8">Shipment Management</h1>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left Column: Unshipped Boxes -->
                <div class="lg:col-span-3">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Unshipped Boxes (<span id="unshipped-count">0</span>)</h2>
                    <div class="space-y-4">
                        <div class="relative">
                            <i class="ph-bold ph-magnifying-glass text-lg absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="search-input" placeholder="Scan or Search by Box ID..." class="w-full pl-12 pr-4 py-2 border rounded-lg shadow-sm">
                        </div>
                        <div class="relative">
                            <i class="ph-bold ph-truck-light text-lg absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <select id="courier-filter" class="w-full pl-12 pr-4 py-2 border rounded-lg shadow-sm"></select>
                        </div>
                        <div id="unshipped-boxes-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                            <div id="unshipped-placeholder" class="text-center py-16 bg-white rounded-2xl shadow-md border border-slate-200">
                                <div class="h-12 w-12 border-4 border-indigo-500 border-t-transparent rounded-full spinner mx-auto"></div>
                                <p class="mt-4 font-semibold text-slate-600">Loading packed boxes...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Column: Shipments -->
                <div class="lg:col-span-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Today's Shipments</h2>
                    <!-- New Shipment Staging Area -->
                    <div id="new-shipment-zone" class="drop-zone bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-6">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">Create New Shipment</h3>
                            <span id="new-shipment-courier" class="text-sm font-bold text-indigo-700 bg-indigo-100 px-3 py-1 rounded-full hidden"></span>
                        </div>
                        <div id="new-shipment-boxes" class="mt-2 min-h-[60px] bg-slate-50 rounded-lg p-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                            <p id="new-shipment-placeholder" class="col-span-full text-center text-sm text-slate-400 py-4">Scan, click, or drag boxes here</p>
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div class="relative">
                                <i class="ph-bold ph-airplane text-lg absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="docket-number-input" placeholder="Enter Docket/AWB Number" class="w-full pl-12 pr-4 py-2 border rounded-lg shadow-sm">
                            </div>
                            <button id="create-shipment-btn" class="w-full flex items-center justify-center space-x-2 bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 disabled:bg-slate-400 transition-colors">
                                <i class="ph-bold ph-arrow-circle-right text-lg"></i>
                                <span>Create Shipment</span>
                            </button>
                        </div>
                    </div>
                    <!-- Existing Shipments -->
                    <div id="shipments-list" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2">
                        <p id="shipments-placeholder" class="text-center text-slate-500 py-16">No shipments created today.</p>
                    </div>
                </div>

                <!-- Right Column: Details & Log -->
                <div class="lg:col-span-3">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Details & Log</h2>
                    <div id="details-panel" class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-6 hidden"></div>
                    <div id="details-placeholder" class="text-center py-12 bg-white rounded-2xl shadow-lg border border-slate-200 mb-6"><p class="text-slate-500">Select a shipment to see details</p></div>
                    <div id="activity-log" class="bg-white p-4 rounded-2xl shadow-lg border border-slate-200 space-y-3 h-[40vh] overflow-y-auto flex flex-col-reverse">
                        <p id="activity-placeholder" class="text-sm text-slate-400 text-center pt-12">No activity yet.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script type="module">
        // --- CONFIGURATION ---
        const SUPABASE_URL = typeof __supabase_url !== 'undefined' ? __supabase_url : 'https://jyzbdkuizwvqamsxqdfg.supabase.co';
        const SUPABASE_ANON_KEY = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emJka3Vpend2cWFtc3hxZGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTE2MzUsImV4cCI6MjA2OTk4NzYzNX0.AqcKHtGPjm5fSijgjh8CMzrqRuheDRAefyU0prPwY2I';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const { jsPDF } = window.jspdf;

        // --- STATE MANAGEMENT ---
        let unshippedBoxes = [];
        let shipments = [];
        let couriers = [];
        let newShipmentBoxIds = new Set();
        let selectedShipmentId = null;
        let currentUser = null;

        // --- UI ELEMENTS ---
        const UI = {
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            themeToggle: document.getElementById('theme-toggle'),
            themeCircle: document.getElementById('theme-circle'),
            userDisplay: document.getElementById('user-display'),
            userInitials: document.getElementById('user-initials'),
            userRoleDisplay: document.getElementById('user-role-display'),
            logoutBtn: document.getElementById('logout-btn'),
            toastContainer: document.getElementById('toast-container'),
            unshippedCount: document.getElementById('unshipped-count'),
            unshippedList: document.getElementById('unshipped-boxes-list'),
            unshippedPlaceholder: document.getElementById('unshipped-placeholder'),
            searchInput: document.getElementById('search-input'),
            courierFilter: document.getElementById('courier-filter'),
            shipmentsList: document.getElementById('shipments-list'),
            shipmentsPlaceholder: document.getElementById('shipments-placeholder'),
            newShipmentZone: document.getElementById('new-shipment-zone'),
            newShipmentBoxes: document.getElementById('new-shipment-boxes'),
            newShipmentPlaceholder: document.getElementById('new-shipment-placeholder'),
            newShipmentCourier: document.getElementById('new-shipment-courier'),
            docketInput: document.getElementById('docket-number-input'),
            createShipmentBtn: document.getElementById('create-shipment-btn'),
            detailsPanel: document.getElementById('details-panel'),
            detailsPlaceholder: document.getElementById('details-placeholder'),
            activityLog: document.getElementById('activity-log'),
            activityPlaceholder: document.getElementById('activity-placeholder'),
        };

        // --- UTILITY FUNCTIONS ---
        const redirectTo = (page) => {
            const currentPath = window.location.pathname;
            const newPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1) + page;
            window.location.href = new URL(newPath, window.location.origin).href;
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            let bgColor = 'bg-slate-800';
            let icon = `<i class="ph-bold ph-info text-white"></i>`;
            if (type === 'success') {
                bgColor = 'bg-emerald-600';
                icon = `<i class="ph-bold ph-check-circle text-white"></i>`;
            } else if (type === 'error') {
                bgColor = 'bg-rose-600';
                icon = `<i class="ph-bold ph-x-circle text-white"></i>`;
            }

            toast.className = `toast px-4 py-3 rounded-lg text-white shadow-lg flex items-center space-x-3 transform translate-y-full opacity-0 ${bgColor}`;
            toast.innerHTML = `${icon} <span class="font-semibold text-sm">${message}</span>`;
            UI.toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        };
        
        const setTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                UI.themeCircle.style.transform = 'translateX(20px)';
                UI.themeCircle.style.backgroundColor = '#64748b';
            } else {
                UI.themeCircle.style.transform = 'translateX(0)';
                UI.themeCircle.style.backgroundColor = '#fff';
            }
        };

        const addLogEntry = (message, type = 'info') => {
            UI.activityPlaceholder.classList.add('hidden');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            let icon;
            switch(type) {
                case 'success': icon = `<i class="ph-bold ph-check-circle text-emerald-500"></i>`; break;
                case 'error': icon = `<i class="ph-bold ph-x-circle text-rose-500"></i>`; break;
                default: icon = `<i class="ph-bold ph-info text-slate-400"></i>`;
            }
            div.className = 'flex items-start space-x-3 text-sm';
            div.innerHTML = `<div class="flex-shrink-0">${icon}</div><div class="flex-grow"><p class="text-slate-700">${message}</p><p class="text-xs text-slate-400">${time}</p></div>`;
            UI.activityLog.prepend(div);
        };

        // --- CORE LOGIC ---
        const fetchInitialData = async () => {
            const today = new Date().toISOString().split('T')[0];
            const { data: boxesData, error: boxesError } = await db.from('boxes')
                .select(`box_id, delivery_groups(stores!inner(courier_id, couriers(name)))`)
                .eq('status', 'Packed');

            const { data: shipmentsData, error: shipmentsError } = await db.from('shipments')
                .select(`*, shipment_items(box_id), couriers(name)`)
                .eq('shipment_date', today);
            
            const { data: couriersData, error: couriersError } = await db.from('couriers').select('*');

            if (boxesError || shipmentsError || couriersError) {
                showToast('Error fetching initial data.', 'error');
                return;
            }
            
            couriers = couriersData;
            shipments = shipmentsData.sort((a, b) => a.docket_number.localeCompare(b.docket_number));
            const shippedBoxIds = shipments.flatMap(s => s.shipment_items.map(item => item.box_id));
            
            unshippedBoxes = boxesData
                .filter(box => !shippedBoxIds.includes(box.box_id))
                .map(box => ({
                    box_id: box.box_id,
                    courier_id: box.delivery_groups.stores[0].courier_id,
                    courier_name: box.delivery_groups.stores[0].couriers.name,
                }));

            renderAll();
        };

        const handleSelectBox = (boxId) => {
            const box = unshippedBoxes.find(b => b.box_id === boxId);
            if (!box) return;

            if (newShipmentBoxIds.size > 0) {
                const firstBox = unshippedBoxes.find(b => b.box_id === [...newShipmentBoxIds][0]);
                if (box.courier_id !== firstBox.courier_id) {
                    showToast(`Error: Cannot mix couriers. This shipment is for ${firstBox.courier_name}.`, 'error');
                    return;
                }
            }
            
            newShipmentBoxIds.add(boxId);
            renderNewShipmentZone();
        };

        const handleCreateShipment = async () => {
            const docketNumber = UI.docketInput.value.trim();
            if (newShipmentBoxIds.size === 0 || !docketNumber) {
                showToast('Add boxes and a docket number first.', 'error'); return;
            }

            const boxes = [...newShipmentBoxIds].map(id => unshippedBoxes.find(b => b.box_id === id));
            const firstCourierId = boxes[0].courier_id;
            
            const { data: shipment, error: shipmentError } = await db.from('shipments').insert({ docket_number: docketNumber, courier_id: firstCourierId, status: 'Dispatched' }).select().single();
            if (shipmentError) { showToast(`Error: ${shipmentError.message}`, 'error'); return; }

            const items = [...newShipmentBoxIds].map(box_id => ({ shipment_id: shipment.id, box_id }));
            const { error: itemsError } = await db.from('shipment_items').insert(items);
            if (itemsError) { showToast(`Error linking boxes: ${itemsError.message}`, 'error'); return; }

            addLogEntry(`Shipment <strong class="font-mono">${docketNumber}</strong> created with ${items.length} boxes by ${currentUser.name}.`, 'success');
            showToast(`Shipment ${docketNumber} created!`, 'success');
            
            newShipmentBoxIds.clear();
            UI.docketInput.value = '';
            fetchInitialData();
        };
        
        const handleAddToShipment = async (shipmentId, boxId) => {
            const shipment = shipments.find(s => s.id == shipmentId);
            const box = unshippedBoxes.find(b => b.box_id === boxId);
            if (shipment.courier_id !== box.courier_id) {
                showToast(`Error: Box courier (${box.courier_name}) does not match shipment courier (${shipment.courier_name}).`, 'error');
                return;
            }

            const { error } = await db.from('shipment_items').insert({ shipment_id: shipmentId, box_id: boxId });
            if (error) { showToast(`Error adding box: ${error.message}`, 'error'); } 
            else {
                addLogEntry(`Box <strong class="font-mono">${boxId}</strong> added to <strong class="font-mono">${shipment.docket_number}</strong>.`, 'info');
                showToast(`Added ${boxId} to shipment.`, 'success');
                fetchInitialData();
            }
        };
        
        const handlePrintManifest = (shipmentId) => {
            const shipment = shipments.find(s => s.id == shipmentId);
            if (!shipment) return;

            const doc = new jsPDF();
            doc.setFontSize(22);
            doc.text('Shipment Manifest', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Date: ${new Date(shipment.shipment_date).toLocaleDateString()}`, 20, 40);
            doc.text(`Courier: ${shipment.couriers.name}`, 20, 50);
            doc.text(`Docket / AWB: ${shipment.docket_number}`, 20, 60);

            doc.autoTable({
                startY: 70,
                head: [['#', 'Box ID']],
                body: shipment.shipment_items.map((item, index) => [index + 1, item.box_id]),
            });

            const finalY = doc.lastAutoTable.finalY || 100;
            doc.text(`Total Boxes: ${shipment.shipment_items.length}`, 20, finalY + 10);
            doc.text('Received By: ___________________', 20, finalY + 30);
            doc.text('Signature: ___________________', 120, finalY + 30);

            doc.save(`Manifest-${shipment.docket_number}.pdf`);
            addLogEntry(`Manifest printed for <strong class="font-mono">${shipment.docket_number}</strong>.`);
        };

        // --- RENDER FUNCTIONS ---
        const renderUnshippedBoxes = () => {
            const searchTerm = UI.searchInput.value.toLowerCase();
            const courierFilter = UI.courierFilter.value;

            const filteredBoxes = unshippedBoxes.filter(box => {
                const searchMatch = box.box_id.toLowerCase().includes(searchTerm);
                const courierMatch = courierFilter === 'all' || box.courier_id == courierFilter;
                return searchMatch && courierMatch;
            });
            
            UI.unshippedCount.textContent = filteredBoxes.length;
            UI.unshippedList.innerHTML = '';

            if (filteredBoxes.length === 0) {
                UI.unshippedPlaceholder.innerHTML = `<p class="text-center text-slate-500 py-16">No packed boxes match filters.</p>`;
                UI.unshippedList.appendChild(UI.unshippedPlaceholder);
            } else {
                filteredBoxes.forEach(box => {
                    const div = document.createElement('div');
                    div.className = 'box-item bg-white p-3 rounded-lg shadow-sm cursor-pointer border-l-slate-300';
                    div.draggable = true;
                    div.dataset.boxId = box.box_id;
                    div.innerHTML = `<p class="font-bold text-sm font-mono">${box.box_id}</p><p class="text-xs text-slate-600">${box.courier_name}</p>`;
                    div.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', box.box_id));
                    div.addEventListener('click', () => handleSelectBox(box.box_id));
                    UI.unshippedList.appendChild(div);
                });
            }
        };

        const renderNewShipmentZone = () => {
            UI.newShipmentBoxes.innerHTML = '';
            if (newShipmentBoxIds.size === 0) {
                UI.newShipmentBoxes.appendChild(UI.newShipmentPlaceholder);
                UI.newShipmentCourier.classList.add('hidden');
            } else {
                const firstBox = unshippedBoxes.find(b => b.box_id === [...newShipmentBoxIds][0]);
                UI.newShipmentCourier.textContent = firstBox.courier_name;
                UI.newShipmentCourier.classList.remove('hidden');

                newShipmentBoxIds.forEach(boxId => {
                    const div = document.createElement('div');
                    div.className = 'bg-indigo-100 text-indigo-800 text-xs font-semibold p-2 rounded-md text-center';
                    div.textContent = boxId;
                    UI.newShipmentBoxes.appendChild(div);
                });
            }
            UI.createShipmentBtn.disabled = newShipmentBoxIds.size === 0 || UI.docketInput.value.trim() === '';
        };

        const renderShipments = () => {
            UI.shipmentsList.innerHTML = '';
            if (shipments.length === 0) {
                UI.shipmentsList.appendChild(UI.shipmentsPlaceholder);
            } else {
                shipments.forEach(shipment => {
                    const div = document.createElement('div');
                    div.className = 'drop-zone bg-white border rounded-lg p-4 cursor-pointer hover:bg-slate-50';
                    div.dataset.shipmentId = shipment.id;
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-indigo-700">${shipment.docket_number}</p>
                                <p class="text-sm font-medium text-slate-600">${shipment.couriers.name}</p>
                            </div>
                            <span class="text-sm bg-slate-100 px-2 py-1 rounded-full">${shipment.shipment_items.length} boxes</span>
                        </div>
                    `;
                    div.addEventListener('click', () => { selectedShipmentId = shipment.id; renderDetailsPanel(); });
                    div.addEventListener('dragenter', e => { e.preventDefault(); e.stopPropagation(); div.classList.add('drag-over'); });
                    div.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); div.classList.add('drag-over'); });
                    div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
                    div.addEventListener('drop', e => {
                        e.preventDefault();
                        div.classList.remove('drag-over');
                        const boxId = e.dataTransfer.getData('text/plain');
                        handleAddToShipment(shipment.id, boxId);
                    });
                    UI.shipmentsList.appendChild(div);
                });
            }
        };

        const renderDetailsPanel = () => {
            if (!selectedShipmentId) {
                UI.detailsPanel.classList.add('hidden');
                UI.detailsPlaceholder.classList.remove('hidden');
                return;
            }
            
            const shipment = shipments.find(s => s.id === selectedShipmentId);
            if (!shipment) return;

            UI.detailsPlaceholder.classList.add('hidden');
            UI.detailsPanel.classList.remove('hidden');
            UI.detailsPanel.innerHTML = `
                <h3 class="text-xl font-bold text-slate-800">${shipment.docket_number}</h3>
                <p class="text-sm text-slate-500 mb-4">${shipment.couriers.name}</p>
                <p class="font-semibold mb-2">Boxes (${shipment.shipment_items.length})</p>
                <ul class="max-h-40 overflow-y-auto space-y-1 pr-2 mb-4">
                    ${shipment.shipment_items.map(item => `<li class="bg-slate-100 p-1 rounded text-xs font-mono">${item.box_id}</li>`).join('')}
                </ul>
                <button id="print-manifest-btn" class="w-full flex items-center justify-center space-x-2 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">
                    <i class="ph-bold ph-printer"></i>
                    <span>Print Manifest</span>
                </button>
            `;
            document.getElementById('print-manifest-btn').addEventListener('click', () => handlePrintManifest(shipment.id));
        };
        
        const renderFilters = () => {
            UI.courierFilter.innerHTML = '<option value="all">All Couriers</option>' + couriers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        };

        const renderAll = () => {
            renderFilters();
            renderUnshippedBoxes();
            renderNewShipmentZone();
            renderShipments();
            renderDetailsPanel();
        };

        const initializeAuth = async () => {
            const { data: { session } } = await db.auth.getSession();
            if (!session) {
                redirectTo('login.html');
                return;
            }
            
            const { data: { user } } = await db.auth.getUser();
            const { data: userProfile, error } = await db.from('users').select('full_name, role').eq('id', user.id).single();
            
            if (error || !userProfile) {
                console.error("Could not fetch user profile:", error);
                currentUser = { id: user.id, name: user.email, role: 'manager' };
            } else {
                currentUser = { id: user.id, name: userProfile.full_name, role: userProfile.role };
            }
            
            UI.userDisplay.textContent = currentUser.name;
            UI.userRoleDisplay.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            UI.userInitials.textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            fetchInitialData();
            addLogEntry('Shipment Management page loaded.');
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- EVENT LISTENERS ---
            UI.searchInput.addEventListener('input', renderUnshippedBoxes);
            UI.searchInput.addEventListener('change', (e) => {
                const boxId = e.target.value.trim();
                const boxExists = unshippedBoxes.some(b => b.box_id === boxId);
                if (boxExists) {
                    handleSelectBox(boxId);
                    e.target.value = '';
                    renderUnshippedBoxes();
                } else if (boxId) {
                    showToast(`Box ${boxId} not found or already shipped.`, 'error');
                }
            });
            UI.courierFilter.addEventListener('change', renderUnshippedBoxes);
            UI.docketInput.addEventListener('input', renderNewShipmentZone);
            UI.createShipmentBtn.addEventListener('click', handleCreateShipment);
            UI.logoutBtn.addEventListener('click', async () => {
                await db.auth.signOut();
                redirectTo('login.html');
            });
            UI.sidebarToggle.addEventListener('click', () => {
                UI.sidebar.classList.toggle('collapsed');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-right');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-left');
            });
            UI.themeToggle.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            });
            
            // Drag and Drop for New Shipment Zone
            ['dragover', 'dragenter'].forEach(event => UI.newShipmentZone.addEventListener(event, e => { e.preventDefault(); UI.newShipmentZone.classList.add('drag-over'); }));
            UI.newShipmentZone.addEventListener('dragleave', () => UI.newShipmentZone.classList.remove('drag-over'));
            UI.newShipmentZone.addEventListener('drop', e => {
                e.preventDefault();
                UI.newShipmentZone.classList.remove('drag-over');
                const boxId = e.dataTransfer.getData('text/plain');
                handleSelectBox(boxId);
            });
            
            // Start the application
            setTheme(localStorage.getItem('theme') || 'light');
            initializeAuth();
        });
    </script>
</body>
</html>
