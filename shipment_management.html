<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Dispatch - Advanced Shipment Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .box-item { transition: all 0.2s ease-in-out; border-left-width: 4px; }
        .box-item.selected { background-color: #dbeafe; border-color: #3b82f6; transform: scale(1.02); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .shipment-card { transition: all 0.2s ease-in-out; }
        .shipment-card.drop-active { border-style: dashed; border-color: #3b82f6; background-color: #eff6ff; }
        .toast { transition: all 0.5s ease; transform: translateY(100%); opacity: 0; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto max-w-7xl my-8">
        <!-- Header -->
        <header class="bg-white shadow-md rounded-t-lg p-6 border-b flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 003.375-3.375h1.5a1.125 1.125 0 011.125 1.125v-1.5a3.375 3.375 0 00-3.375-3.375H3.375" /></svg>
                <h1 class="text-2xl font-bold text-gray-800">Shipment Management</h1>
            </div>
            <button id="refresh-btn" class="p-2 rounded-full hover:bg-gray-100" title="Refresh Data">
                <svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-11.664 0l4.992-4.993m-4.993 0l-3.181 3.183a8.25 8.25 0 000 11.664l3.181 3.183" /></svg>
            </button>
        </header>

        <!-- Main Content -->
        <main class="bg-white shadow-md rounded-b-lg p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Main View -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Filters -->
                <div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="search-input" placeholder="Search by Box ID or Docket..." class="w-full p-2 border rounded-md">
                        <select id="courier-filter" class="w-full p-2 border rounded-md"></select>
                    </div>
                </div>
                <!-- Unshipped Boxes -->
                <div>
                    <h2 class="text-xl font-semibold mb-4">Unshipped Boxes (<span id="unshipped-count">0</span>)</h2>
                    <div id="packed-boxes-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 min-h-[20vh] p-4 bg-gray-50 rounded-lg border">
                        <p id="no-boxes-message" class="col-span-full text-center text-gray-500 py-16">No packed boxes match your filters.</p>
                    </div>
                </div>
                <!-- Dispatched Shipments -->
                <div>
                    <h2 class="text-xl font-semibold mb-4">Today's Shipments</h2>
                    <div id="dispatched-shipments-list" class="space-y-4">
                         <p id="no-shipments-message" class="text-center text-gray-500 py-16">No shipments dispatched today.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Actions -->
            <div class="lg:col-span-1 bg-gray-50 p-6 rounded-lg border sticky top-8">
                <h2 class="text-xl font-semibold mb-4">Actions</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-medium text-gray-800">1. Selected Boxes (<span id="selected-count">0</span>)</h3>
                        <div id="selected-boxes-list" class="mt-2 text-sm text-gray-600 max-h-40 overflow-y-auto space-y-1 pr-2">
                            <p class="text-gray-400">Click on boxes from the "Unshipped" list to select them.</p>
                        </div>
                    </div>
                    <div>
                        <label for="docket-number" class="block text-sm font-medium text-gray-700">2. New Docket Number (AWB)</label>
                        <input type="text" id="docket-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-lg p-2" placeholder="Scan or type new AWB">
                    </div>
                    <div>
                        <button id="create-shipment-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400">Create New Shipment</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-8 right-8 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>

    <!-- Shipment Details Modal -->
    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Shipment Details</h2>
                <button id="close-modal-btn" class="p-1">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script type="module">
        const { createClient } = supabase;
        const { jsPDF } = window.jspdf;
        const SUPABASE_URL = 'https://jyzbdkuizwvqamsxqdfg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emJka3Vpend2cWFtc3hxZGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTE2MzUsImV4cCI6MjA2OTk4NzYzNX0.AqcKHtGPjm5fSijgjh8CMzrqRuheDRAefyU0prPwY2I';
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const state = {
            unshippedBoxes: [],
            dispatchedShipments: [],
            couriers: [],
            selectedBoxIds: new Set(),
            filters: { search: '', courier: 'all' }
        };

        const UI = {
            searchInput: document.getElementById('search-input'),
            courierFilter: document.getElementById('courier-filter'),
            unshippedCount: document.getElementById('unshipped-count'),
            packedBoxesList: document.getElementById('packed-boxes-list'),
            noBoxesMessage: document.getElementById('no-boxes-message'),
            dispatchedShipmentsList: document.getElementById('dispatched-shipments-list'),
            noShipmentsMessage: document.getElementById('no-shipments-message'),
            selectedCount: document.getElementById('selected-count'),
            selectedBoxesList: document.getElementById('selected-boxes-list'),
            docketNumberInput: document.getElementById('docket-number'),
            createShipmentBtn: document.getElementById('create-shipment-btn'),
            refreshBtn: document.getElementById('refresh-btn'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            detailsModal: document.getElementById('details-modal'),
            modalContent: document.getElementById('modal-content'),
            closeModalBtn: document.getElementById('close-modal-btn'),
        };

        function showToast(message, isError = false) {
            UI.toastMessage.textContent = message;
            UI.toast.className = `toast fixed bottom-8 right-8 text-white py-3 px-6 rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
            UI.toast.classList.add('show');
            setTimeout(() => UI.toast.classList.remove('show'), 3000);
        }

        async function fetchInitialData() {
            const today = new Date().toISOString().split('T')[0];
            const [
                { data: shipments, error: shipmentError },
                { data: boxes, error: boxError },
                { data: couriers, error: couriersError }
            ] = await Promise.all([
                db.from('shipments').select(`*, shipment_items(box_id), couriers(name)`).eq('shipment_date', today),
                db.from('boxes').select(`*, delivery_groups(*, stores!inner(*, couriers(*)))`).eq('dispatch_date', today).eq('status', 'Packed'),
                db.from('couriers').select('*')
            ]);
            
            if (shipmentError || boxError || couriersError) {
                showToast('Error fetching data from database.', true);
                return;
            }

            state.dispatchedShipments = shipments || [];
            state.couriers = couriers || [];
            const shippedBoxIds = state.dispatchedShipments.flatMap(s => s.shipment_items.map(item => item.box_id));
            state.unshippedBoxes = (boxes || []).filter(box => !shippedBoxIds.includes(box.box_id));
            
            renderAll();
        }

        function renderAll() {
            const filteredBoxes = state.unshippedBoxes.filter(box => {
                const searchMatch = box.box_id.toLowerCase().includes(state.filters.search.toLowerCase());
                const courierMatch = state.filters.courier === 'all' || box.delivery_groups.stores[0].courier_id == state.filters.courier;
                return searchMatch && courierMatch;
            });

            renderFilters();
            renderUnshippedBoxes(filteredBoxes);
            renderDispatchedShipments();
            renderSelectedBoxes();
        }
        
        function renderFilters() {
            UI.courierFilter.innerHTML = '<option value="all">All Couriers</option>' + state.couriers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            UI.courierFilter.value = state.filters.courier;
        }

        function renderUnshippedBoxes(boxes) {
            UI.unshippedCount.textContent = boxes.length;
            if (boxes.length === 0) {
                UI.noBoxesMessage.classList.remove('hidden');
                UI.packedBoxesList.innerHTML = '';
            } else {
                UI.noBoxesMessage.classList.add('hidden');
                UI.packedBoxesList.innerHTML = boxes.map(box => {
                    const courier = box.delivery_groups.stores[0].couriers;
                    const isSelected = state.selectedBoxIds.has(box.box_id);
                    return `
                        <div class="box-item border-gray-300 rounded-lg p-3 cursor-pointer hover:shadow-md ${isSelected ? 'selected' : 'bg-white'}" data-box-id="${box.box_id}" draggable="true">
                            <p class="font-bold text-sm">${box.box_id}</p>
                            <p class="text-xs text-gray-600">${courier.name}</p>
                        </div>
                    `;
                }).join('');
            }
            addBoxEventListeners();
        }
        
        function renderDispatchedShipments() {
             if (state.dispatchedShipments.length === 0) {
                UI.noShipmentsMessage.classList.remove('hidden');
                UI.dispatchedShipmentsList.innerHTML = '';
            } else {
                UI.noShipmentsMessage.classList.add('hidden');
                UI.dispatchedShipmentsList.innerHTML = state.dispatchedShipments.map(shipment => `
                    <div class="shipment-card bg-white border rounded-lg" data-shipment-id="${shipment.id}">
                        <div class="p-4 flex justify-between items-center">
                            <div>
                                <a href="#" class="font-bold text-green-700 hover:underline" data-action="view-details">${shipment.docket_number}</a>
                                <p class="text-sm font-medium">${shipment.couriers.name}</p>
                            </div>
                            <div>
                                <span class="text-sm bg-gray-100 px-2 py-1 rounded-full">${shipment.shipment_items.length} boxes</span>
                                <button class="ml-4 text-blue-600 hover:text-blue-800" data-action="print-manifest" title="Print Manifest">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            addShipmentEventListeners();
        }

        function renderSelectedBoxes() {
            UI.selectedCount.textContent = state.selectedBoxIds.size;
            if (state.selectedBoxIds.size === 0) {
                UI.selectedBoxesList.innerHTML = '<p class="text-gray-400">Click or drag boxes to select.</p>';
            } else {
                UI.selectedBoxesList.innerHTML = [...state.selectedBoxIds].map(id => `<div class="bg-white p-1 rounded text-xs shadow-sm">${id}</div>`).join('');
            }
            UI.createShipmentBtn.disabled = state.selectedBoxIds.size === 0 || UI.docketNumberInput.value.trim() === '';
        }

        async function handleCreateShipment() {
            const docketNumber = UI.docketNumberInput.value.trim();
            if (state.selectedBoxIds.size === 0 || !docketNumber) {
                showToast('Please select boxes and enter a docket number.', true);
                return;
            }

            const boxDetails = [...state.selectedBoxIds].map(id => state.unshippedBoxes.find(b => b.box_id === id));
            const firstCourierId = boxDetails[0].delivery_groups.stores[0].courier_id;
            if (!boxDetails.every(b => b.delivery_groups.stores[0].courier_id === firstCourierId)) {
                showToast('All selected boxes must belong to the same courier.', true);
                return;
            }

            const { data: shipment, error: shipmentError } = await db.from('shipments')
                .insert({ docket_number: docketNumber, courier_id: firstCourierId, status: 'Dispatched' }).select().single();

            if (shipmentError) { showToast(`Error: ${shipmentError.message}`, true); return; }

            const shipmentItems = [...state.selectedBoxIds].map(box_id => ({ shipment_id: shipment.id, box_id }));
            const { error: itemsError } = await db.from('shipment_items').insert(shipmentItems);
            
            if (itemsError) { showToast(`Error linking boxes: ${itemsError.message}`, true); return; }

            showToast(`Shipment ${docketNumber} created!`);
            UI.docketNumberInput.value = '';
            state.selectedBoxIds.clear();
            fetchInitialData();
        }
        
        async function handleAddToShipment(shipmentId, boxIds) {
            const shipmentItems = boxIds.map(box_id => ({ shipment_id: shipmentId, box_id }));
            const { error } = await db.from('shipment_items').insert(shipmentItems);
            if (error) {
                showToast(`Error adding boxes: ${error.message}`, true);
            } else {
                showToast(`Added ${boxIds.length} boxes to shipment.`);
                state.selectedBoxIds.clear();
                fetchInitialData();
            }
        }

        function handlePrintManifest(shipmentId) {
            const shipment = state.dispatchedShipments.find(s => s.id == shipmentId);
            if (!shipment) return;

            const doc = new jsPDF();
            doc.setFontSize(22);
            doc.text('Shipment Manifest', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Date: ${new Date(shipment.shipment_date).toLocaleDateString()}`, 20, 40);
            doc.text(`Courier: ${shipment.couriers.name}`, 20, 50);
            doc.text(`Docket / AWB: ${shipment.docket_number}`, 20, 60);

            doc.autoTable({
                startY: 70,
                head: [['#', 'Box ID']],
                body: shipment.shipment_items.map((item, index) => [index + 1, item.box_id]),
            });

            const finalY = doc.lastAutoTable.finalY || 100;
            doc.text(`Total Boxes: ${shipment.shipment_items.length}`, 20, finalY + 10);
            doc.text('Received By: ___________________', 20, finalY + 30);
            doc.text('Signature: ___________________', 120, finalY + 30);

            doc.save(`Manifest-${shipment.docket_number}.pdf`);
        }
        
        async function showDetailsModal(shipmentId) {
            const shipment = state.dispatchedShipments.find(s => s.id == shipmentId);
            UI.modalContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="font-bold">Docket Number</label>
                        <input id="edit-docket-input" class="w-full p-2 border rounded" value="${shipment.docket_number}">
                    </div>
                    <div>
                        <p class="font-bold">Boxes (${shipment.shipment_items.length})</p>
                        <ul class="max-h-60 overflow-y-auto text-sm space-y-1 mt-2">${shipment.shipment_items.map(i => `<li class="bg-gray-100 p-1 rounded">${i.box_id}</li>`).join('')}</ul>
                    </div>
                    <button id="save-docket-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Save Changes</button>
                </div>
            `;
            UI.detailsModal.classList.remove('hidden');
            document.getElementById('save-docket-btn').onclick = async () => {
                const newDocket = document.getElementById('edit-docket-input').value;
                const { error } = await db.from('shipments').update({ docket_number: newDocket }).eq('id', shipmentId);
                if (error) {
                    showToast('Failed to update docket.', true);
                } else {
                    showToast('Docket number updated!');
                    UI.detailsModal.classList.add('hidden');
                    fetchInitialData();
                }
            };
        }

        function addBoxEventListeners() {
            document.querySelectorAll('.box-item').forEach(el => {
                el.addEventListener('click', () => {
                    const boxId = el.dataset.boxId;
                    if (state.selectedBoxIds.has(boxId)) state.selectedBoxIds.delete(boxId);
                    else state.selectedBoxIds.add(boxId);
                    renderAll();
                });
                el.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', el.dataset.boxId);
                    e.dataTransfer.effectAllowed = 'move';
                });
            });
        }
        
        function addShipmentEventListeners() {
            document.querySelectorAll('.shipment-card').forEach(el => {
                el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('drop-active'); });
                el.addEventListener('dragleave', () => el.classList.remove('drop-active'));
                el.addEventListener('drop', e => {
                    e.preventDefault();
                    el.classList.remove('drop-active');
                    const boxId = e.dataTransfer.getData('text/plain');
                    const shipmentId = el.dataset.shipmentId;
                    handleAddToShipment(shipmentId, [boxId]);
                });
                el.addEventListener('click', e => {
                    if (e.target.closest('[data-action="print-manifest"]')) {
                        handlePrintManifest(el.dataset.shipmentId);
                    }
                    if (e.target.closest('[data-action="view-details"]')) {
                        e.preventDefault();
                        showDetailsModal(el.dataset.shipmentId);
                    }
                });
            });
        }

        // --- Init & Event Listeners ---
        UI.refreshBtn.addEventListener('click', fetchInitialData);
        UI.searchInput.addEventListener('input', () => { state.filters.search = UI.searchInput.value; renderAll(); });
        UI.courierFilter.addEventListener('change', () => { state.filters.courier = UI.courierFilter.value; renderAll(); });
        UI.createShipmentBtn.addEventListener('click', handleCreateShipment);
        UI.docketNumberInput.addEventListener('input', renderSelectedBoxes);
        UI.closeModalBtn.addEventListener('click', () => UI.detailsModal.classList.add('hidden'));

        // Load initial data and subscribe to changes
        fetchInitialData();
        db.channel('realtime-shipments')
          .on('postgres_changes', { event: '*', schema: 'public' }, payload => {
            fetchInitialData();
          }).subscribe();
        
        // Need to import this for the PDF generation
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/jspdf-autotable';
        document.head.appendChild(script);
    </script>
</body>
</html>
