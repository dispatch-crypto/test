<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Dispatch - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .stat-card { transition: transform 0.2s ease-in-out; }
        .stat-card:hover { transform: translateY(-5px); }
        .box-card {
            transition: all 0.2s ease-in-out;
            border-left-width: 4px;
        }
        .box-card.urgent {
            border-left-color: #ef4444; /* red-500 */
            background-color: #fef2f2; /* red-50 */
        }
        .box-card.standard {
            border-left-color: #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-1.036.84-1.875 1.875-1.875h13.5c1.036 0 1.875.84 1.875 1.875v14.25c0 1.036-.84 1.875-1.875-1.875H5.625c-1.036 0-1.875-.84-1.875-1.875V4.875z" /><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 18.75h9M7.5 12h9m-9-6.25h9" /></svg>
                    <h1 class="text-2xl font-bold text-gray-800">Dispatch Dashboard</h1>
                </div>
                <button id="refresh-btn" class="p-2 rounded-full hover:bg-gray-100" title="Refresh Data">
                    <svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-11.664 0l4.992-4.993m-4.993 0l-3.181 3.183a8.25 8.25 0 000 11.664l3.181 3.183" /></svg>
                </button>
            </div>
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-6 text-center">
                <div class="stat-card bg-gray-50 p-4 rounded-lg"><p class="text-3xl font-bold text-blue-600" id="stat-total-orders">0</p><p class="text-sm font-medium text-gray-500">Total Orders</p></div>
                <div class="stat-card bg-gray-50 p-4 rounded-lg"><p class="text-3xl font-bold text-yellow-600" id="stat-pending">0</p><p class="text-sm font-medium text-gray-500">Pending Packing</p></div>
                <div class="stat-card bg-gray-50 p-4 rounded-lg"><p class="text-3xl font-bold text-green-600" id="stat-packed">0</p><p class="text-sm font-medium text-gray-500">Ready for Shipment</p></div>
                <div class="stat-card bg-gray-50 p-4 rounded-lg"><p class="text-3xl font-bold text-gray-800" id="stat-dispatched">0</p><p class="text-sm font-medium text-gray-500">Shipments Created</p></div>
            </div>
        </header>

        <!-- Main Workflow -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Column 1: Pending Boxes -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Pending Boxes</h2>
                <div id="pending-boxes-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <p id="no-pending-message" class="text-center text-gray-500 py-16">No boxes are pending.</p>
                </div>
            </div>
            <!-- Column 2: Ready for Shipment -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Ready for Shipment</h2>
                <div id="ready-boxes-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <p id="no-ready-message" class="text-center text-gray-500 py-16">No boxes are ready.</p>
                </div>
            </div>
            <!-- Column 3: Dispatched Today -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Dispatched Today</h2>
                <div id="dispatched-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <p id="no-dispatched-message" class="text-center text-gray-500 py-16">No shipments dispatched.</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://jyzbdkuizwvqamsxqdfg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emJka3Vpend2cWFtc3hxZGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTE2MzUsImV4cCI6MjA2OTk4NzYzNX0.AqcKHtGPjm5fSijgjh8CMzrqRuheDRAefyU0prPwY2I';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const UI = {
            statTotalOrders: document.getElementById('stat-total-orders'),
            statPending: document.getElementById('stat-pending'),
            statPacked: document.getElementById('stat-packed'),
            statDispatched: document.getElementById('stat-dispatched'),
            pendingBoxesList: document.getElementById('pending-boxes-list'),
            noPendingMessage: document.getElementById('no-pending-message'),
            readyBoxesList: document.getElementById('ready-boxes-list'),
            noReadyMessage: document.getElementById('no-ready-message'),
            dispatchedList: document.getElementById('dispatched-list'),
            noDispatchedMessage: document.getElementById('no-dispatched-message'),
            refreshBtn: document.getElementById('refresh-btn'),
        };

        const fetchData = async () => {
            const today = new Date().toISOString().split('T')[0];

            // Fetch all data in parallel for speed
            const [
                { data: orders, error: ordersError },
                { data: boxes, error: boxesError },
                { data: shipments, error: shipmentsError }
            ] = await Promise.all([
                db.from('orders').select('gkb_order_no', { count: 'exact' }).eq('order_date', today),
                db.from('boxes').select(`*, delivery_groups(*, stores!inner(*, couriers(name)))`).eq('dispatch_date', today),
                db.from('shipments').select(`*, shipment_items(box_id), couriers(name)`).eq('shipment_date', today)
            ]);

            if (ordersError || boxesError || shipmentsError) {
                console.error("Error fetching data:", ordersError || boxesError || shipmentsError);
                return;
            }

            const shippedBoxIds = (shipments || []).flatMap(s => s.shipment_items.map(item => item.box_id));

            // Categorize boxes
            const pendingBoxes = (boxes || []).filter(b => b.status === 'Pending' || b.status === 'Packing');
            const readyBoxes = (boxes || []).filter(b => b.status === 'Packed' && !shippedBoxIds.includes(b.box_id));

            // Update stats
            UI.statTotalOrders.textContent = orders.length;
            UI.statPending.textContent = pendingBoxes.length;
            UI.statPacked.textContent = readyBoxes.length;
            UI.statDispatched.textContent = shipments.length;

            // Render lists
            renderList(UI.pendingBoxesList, UI.noPendingMessage, pendingBoxes, renderBoxCard);
            renderList(UI.readyBoxesList, UI.noReadyMessage, readyBoxes, renderBoxCard);
            renderList(UI.dispatchedList, UI.noDispatchedMessage, shipments, renderShipmentCard);
        };

        const renderList = (listElement, emptyMessageElement, data, renderFunction) => {
            if (!data || data.length === 0) {
                emptyMessageElement.classList.remove('hidden');
                listElement.innerHTML = '';
            } else {
                emptyMessageElement.classList.add('hidden');
                listElement.innerHTML = data.map(renderFunction).join('');
            }
        };

        const renderBoxCard = (box) => {
            const primaryStore = box.delivery_groups.stores[0];
            const courierName = primaryStore.couriers.name;
            const isUrgent = courierName === 'Delivery Boy';
            return `
                <div class="box-card ${isUrgent ? 'urgent' : 'standard'} bg-white rounded-lg p-4 shadow">
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-sm">${box.box_id}</p>
                        <span class="text-xs px-2 py-1 rounded-full ${box.status === 'Packed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${box.status}</span>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">${courierName}</p>
                    ${isUrgent ? '<p class="text-xs font-bold text-red-600 mt-1">URGENT</p>' : ''}
                </div>
            `;
        };

        const renderShipmentCard = (shipment) => {
            return `
                <div class="bg-white rounded-lg p-4 shadow border-l-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-sm text-green-700">${shipment.docket_number}</p>
                        <p class="text-xs text-gray-600">${shipment.couriers.name}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Contains ${shipment.shipment_items.length} boxes.</p>
                </div>
            `;
        };
        
        // Event Listeners
        UI.refreshBtn.addEventListener('click', fetchData);

        // Initial Load & Real-time Subscription
        fetchData();
        db.channel('public-db-changes')
          .on('postgres_changes', { event: '*', schema: 'public' }, payload => {
            console.log('Change received!', payload);
            fetchData();
          })
          .subscribe();
    </script>
</body>
</html>
