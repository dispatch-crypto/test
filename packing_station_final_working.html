<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing Station - Smart Dispatch</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Phosphor Icons for a clean, modern look -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        [data-theme="dark"] body {
            background-color: #1e293b;
            color: #f1f5f9;
        }
        .sidebar { transition: all 0.3s ease; width: 256px; }
        .sidebar.collapsed { width: 64px; }
        .sidebar-item-text { transition: all 0.3s ease; }
        .sidebar.collapsed .sidebar-item-text { opacity: 0; pointer-events: none; }
        .scanner-input:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
            border-color: #6366f1;
        }
        .queue-item { transition: all 0.2s ease-in-out; border-left-width: 4px; }
        .queue-item.active {
            background-color: #e0e7ff;
            border-left-color: #4f46e5;
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .priority-delivery-boy {
            border-left: 4px solid #facc15;
            background-color: #fefce8;
        }
        .priority-urgent {
             border-left: 4px solid #fb923c;
             background-color: #fff7ed;
        }
        .priority-normal {
            border-left: 4px solid #e2e8f0;
        }
        .packed-item {
            background-color: #f0fdf4;
            color: #6b7280;
            text-decoration: line-through;
        }
        .modal { display: none; }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .toast { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.hide { transform: translateY(100%); opacity: 0; }
        [data-theme="dark"] .bg-slate-50 { background-color: #475569; }
        [data-theme="dark"] .bg-white { background-color: #1f2a3a; color: #f1f5f9; }
        [data-theme="dark"] .bg-indigo-600 { background-color: #4f46e5; }
        [data-theme="dark"] .text-slate-800 { color: #f1f5f9; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-white shadow-xl p-4 flex flex-col justify-between">
            <div>
                <div class="flex items-center justify-between mb-8 p-2">
                    <a href="./index.html" class="flex items-center space-x-3">
                        <div class="bg-indigo-600 p-2 rounded-lg shadow">
                            <i class="ph-bold ph-list-dashes text-white text-lg"></i>
                        </div>
                        <span class="text-xl font-extrabold tracking-tight text-slate-900 sidebar-item-text">Smart Dispatch</span>
                    </a>
                    <button id="sidebar-toggle" class="p-1 rounded-md hover:bg-slate-100">
                        <i class="ph-bold ph-caret-left text-slate-400"></i>
                    </button>
                </div>
                <nav>
    <ul class="space-y-2">
        <li>
            <a href="./index.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-house-simple text-lg"></i>
                <span class="sidebar-item-text">Dashboard</span>
            </a>
        </li>
        <li>
            <a href="./daily_dispatch.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-cloud-arrow-up text-lg"></i>
                <span class="sidebar-item-text">Daily Dispatch</span>
            </a>
        </li>
        <li>
            <a href="./packing_station_final_working.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-package text-lg"></i>
                <span class="sidebar-item-text">Packing Station</span>
            </a>
        </li>
        <li>
            <a href="./shipment_management_final.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-truck text-lg"></i>
                <span class="sidebar-item-text">Shipments</span>
            </a>
        </li>
        <li>
            <a href="./docket_generation.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-file-text text-lg"></i>
                <span class="sidebar-item-text">Generate Dockets</span>
            </a>
        </li>
    </ul>
</nav>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-200 flex items-center justify-center">
                            <span class="font-bold text-indigo-800" id="user-initials"></span>
                        </div>
                        <div class="flex flex-col sidebar-item-text">
                            <span class="text-sm font-semibold text-slate-800" id="user-display">Loading...</span>
                            <span class="text-xs text-slate-500" id="user-role-display"></span>
                        </div>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-md hover:bg-slate-200">
                        <i class="ph-bold ph-sign-out text-slate-500 text-lg"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-3 p-2 rounded-lg bg-slate-50 justify-between">
                    <span class="text-xs font-semibold text-slate-600 sidebar-item-text">Dark Mode</span>
                    <button id="theme-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition-colors">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" id="theme-circle"></span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-6 lg:p-8 overflow-auto">
            <h1 class="text-3xl font-extrabold text-slate-900 mb-8">Packing Station</h1>
            
            <!-- Scanner Input -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8 sticky top-0 z-10">
                <label for="scanner-input" class="block text-sm font-bold text-slate-700 mb-2">Scan Box ID to Activate</label>
                <div class="relative">
                    <i class="ph-bold ph-barcode text-lg absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="scanner-input" placeholder="Waiting for scan..." class="scanner-input w-full pl-12 pr-4 py-3 text-lg font-semibold text-slate-800 bg-slate-50 rounded-lg border-2 border-slate-300 transition-all">
                </div>
            </div>

            <!-- Packing Area -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left: Packing Queue -->
                <div class="lg:col-span-3">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Packing Queue</h2>
                    <div id="packing-queue" class="space-y-3 max-h-[65vh] overflow-y-auto pr-2">
                        <div id="queue-placeholder" class="text-center py-16 bg-white rounded-2xl shadow-md border border-slate-200">
                            <div class="h-12 w-12 border-4 border-indigo-500 border-t-transparent rounded-full spinner mx-auto"></div>
                            <p class="mt-4 font-semibold text-slate-600">Loading today's dispatch...</p>
                        </div>
                    </div>
                </div>

                <!-- Middle: Active Box Area -->
                <div class="lg:col-span-6">
                    <div id="active-box-placeholder" class="flex flex-col items-center justify-center h-full bg-white rounded-2xl shadow-lg border border-slate-200 text-center p-8">
                        <i class="ph-bold ph-package text-6xl text-indigo-300"></i>
                        <h3 class="mt-4 text-xl font-bold text-slate-700">No Active Box</h3>
                        <p class="text-slate-500 mt-1">Scan a Box ID from the queue to begin packing.</p>
                    </div>
                    <div id="active-box-details" class="hidden">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-6">
                            <h2 class="text-2xl font-bold text-indigo-700 font-mono" id="box-id-display"></h2>
                            <p class="text-slate-600 mt-1" id="store-info-display"></p>
                            <div class="mt-4">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm font-medium text-slate-700">Packing Progress</span>
                                    <span class="text-sm font-bold text-slate-800" id="progress-text">0 / 0</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-4">
                                    <div id="progress-bar" class="bg-indigo-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 flex flex-col">
                                <h3 class="text-lg font-semibold mb-4 text-center text-slate-800">Pending Items</h3>
                                <ul id="pending-items" class="space-y-2 overflow-y-auto flex-grow min-h-[200px]"></ul>
                            </div>
                            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 flex flex-col">
                                <h3 class="text-lg font-semibold mb-4 text-center text-slate-800">Packed Items</h3>
                                <ul id="packed-items" class="space-y-2 overflow-y-auto flex-grow min-h-[200px]"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Activity Log -->
                <div class="lg:col-span-3">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Activity Log</h2>
                    <div id="activity-log" class="bg-white p-4 rounded-2xl shadow-lg border border-slate-200 space-y-3 min-h-[65vh] max-h-[65vh] overflow-y-auto flex flex-col-reverse">
                        <p id="activity-placeholder" class="text-sm text-slate-400 text-center pt-12">No activity yet.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals & Toasts -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <!-- Exception Modal -->
    <div id="exception-modal" class="modal fixed inset-0 bg-black/60 z-30 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <h3 class="text-xl leading-6 font-bold text-slate-900">Packing Exception</h3>
            <p class="mt-2 text-slate-500" id="exception-message"></p>
            <div class="mt-6 grid grid-cols-2 gap-4">
                <button id="exception-cancel-btn" class="rounded-lg px-4 py-2.5 bg-slate-200 text-base font-semibold text-slate-800 hover:bg-slate-300">Cancel</button>
                <button id="exception-confirm-btn" class="rounded-lg px-4 py-2.5 bg-rose-600 text-base font-semibold text-white hover:bg-rose-700">Confirm & Move</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const SUPABASE_URL = typeof __supabase_url !== 'undefined' ? __supabase_url : 'https://jyzbdkuizwvqamsxqdfg.supabase.co';
        const SUPABASE_ANON_KEY = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emJka3Vpend2cWFtc3hxZGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTE2MzUsImV4cCI6MjA2OTk4NzYzNX0.AqcKHtGPjm5fSijgjh8CMzrqRuheDRAefyU0prPwY2I';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- STATE MANAGEMENT ---
        let dispatchQueue = [];
        let activeBox = null;
        let currentUser = null;
        let isLoading = false;
        let exceptionContext = null;

        // --- UI ELEMENTS ---
        const UI = {
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            themeToggle: document.getElementById('theme-toggle'),
            themeCircle: document.getElementById('theme-circle'),
            userDisplay: document.getElementById('user-display'),
            userInitials: document.getElementById('user-initials'),
            userRoleDisplay: document.getElementById('user-role-display'),
            logoutBtn: document.getElementById('logout-btn'),
            toastContainer: document.getElementById('toast-container'),
            scannerInput: document.getElementById('scanner-input'),
            scannerLabel: document.querySelector('label[for="scanner-input"]'),
            packingQueue: document.getElementById('packing-queue'),
            queuePlaceholder: document.getElementById('queue-placeholder'),
            activeBoxPlaceholder: document.getElementById('active-box-placeholder'),
            activeBoxDetails: document.getElementById('active-box-details'),
            boxIdDisplay: document.getElementById('box-id-display'),
            storeInfoDisplay: document.getElementById('store-info-display'),
            progressText: document.getElementById('progress-text'),
            progressBar: document.getElementById('progress-bar'),
            pendingItems: document.getElementById('pending-items'),
            packedItems: document.getElementById('packed-items'),
            activityLog: document.getElementById('activity-log'),
            activityPlaceholder: document.getElementById('activity-placeholder'),
            exceptionModal: document.getElementById('exception-modal'),
            exceptionMessage: document.getElementById('exception-message'),
            exceptionCancelBtn: document.getElementById('exception-cancel-btn'),
            exceptionConfirmBtn: document.getElementById('exception-confirm-btn'),
        };

        // --- UTILITY FUNCTIONS ---
        const redirectTo = (page) => {
            const currentPath = window.location.pathname;
            const newPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1) + page;
            window.location.href = new URL(newPath, window.location.origin).href;
        };
        
        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            let bgColor = 'bg-slate-800';
            let icon = `<i class="ph-bold ph-info text-white"></i>`;
            if (type === 'success') {
                bgColor = 'bg-emerald-600';
                icon = `<i class="ph-bold ph-check-circle text-white"></i>`;
            } else if (type === 'error') {
                bgColor = 'bg-rose-600';
                icon = `<i class="ph-bold ph-x-circle text-white"></i>`;
            }

            toast.className = `toast px-4 py-3 rounded-lg text-white shadow-lg flex items-center space-x-3 transform translate-y-full opacity-0 ${bgColor}`;
            toast.innerHTML = `${icon} <span class="font-semibold text-sm">${message}</span>`;
            UI.toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        };
        
        const setTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                UI.themeCircle.style.transform = 'translateX(20px)';
                UI.themeCircle.style.backgroundColor = '#64748b';
            } else {
                UI.themeCircle.style.transform = 'translateX(0)';
                UI.themeCircle.style.backgroundColor = '#fff';
            }
        };

        const addLogEntry = (message, type = 'info') => {
            UI.activityPlaceholder.classList.add('hidden');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            let icon;
            switch(type) {
                case 'success': icon = `<i class="ph-bold ph-check-circle text-emerald-500"></i>`; break;
                case 'error': icon = `<i class="ph-bold ph-x-circle text-rose-500"></i>`; break;
                default: icon = `<i class="ph-bold ph-info text-slate-400"></i>`;
            }
            div.className = 'flex items-start space-x-3 text-sm';
            div.innerHTML = `<div class="flex-shrink-0">${icon}</div><div class="flex-grow"><p class="text-slate-700">${message}</p><p class="text-xs text-slate-400">${time}</p></div>`;
            UI.activityLog.prepend(div);
        };

        // --- CORE LOGIC ---
        const fetchDispatchQueue = async () => {
            const today = new Date().toISOString().split('T')[0];
            
            const { data, error } = await db.from('boxes')
                .select(`
                    box_id,
                    dispatch_date,
                    status,
                    delivery_groups (
                        stores (
                            store_name,
                            city,
                            couriers ( name )
                        )
                    )
                `)
                .eq('dispatch_date', today)
                .in('status', ['Pending', 'Packing']);

            if (error) {
                showToast(`Error fetching queue: ${error.message}`, 'error');
                console.error("Supabase error:", error);
                return;
            }
            
            const processedData = data.map(box => {
                const store = box.delivery_groups?.stores?.[0];
                return {
                    box_id: box.box_id,
                    dispatch_date: box.dispatch_date,
                    status: box.status,
                    store_name: store?.store_name || 'Unknown Store',
                    city: store?.city || 'N/A',
                    courier_name: store?.couriers?.name || 'N/A'
                };
            });

            dispatchQueue = processedData.sort((a, b) => {
                const priorityA = getCourierPriority(a.courier_name);
                const priorityB = getCourierPriority(b.courier_name);
                if (priorityA !== priorityB) return priorityA - priorityB;
                return a.box_id.localeCompare(b.box_id);
            });
            renderQueue();
        };

        const activateBox = async (boxId) => {
            if (isLoading) {
                showToast('Please wait, another operation is in progress.', 'error');
                return;
            }
            isLoading = true;
            UI.scannerInput.disabled = true;
            UI.scannerInput.placeholder = `Loading ${boxId}...`;

            try {
                const { data, error } = await db.from('boxes')
                    .select('*, orders(*), delivery_groups(*, stores(*, couriers(*)))')
                    .eq('box_id', boxId)
                    .limit(1)
                    .single();
                
                if (error || !data) { 
                    showToast(`Error: Box ID "${boxId}" not found.`, 'error'); 
                    return;
                }
                if (data.status === 'Packed') { 
                    showToast(`Box "${boxId}" is already packed.`, 'info'); 
                    fetchDispatchQueue();
                    return; 
                }
                
                const store = data.delivery_groups?.stores?.[0];
                activeBox = { 
                    ...data, 
                    store_name: store?.store_name || 'Unknown Store',
                    city: store?.city || 'N/A',
                    courier_name: store?.couriers?.name || 'N/A'
                };

                addLogEntry(`Box <strong class="font-mono">${boxId}</strong> activated by ${currentUser.name}.`);
                renderActiveBox();
                renderQueue();
            } catch (err) {
                showToast(`An unexpected error occurred: ${err.message}`, 'error');
            } finally {
                isLoading = false;
                UI.scannerInput.disabled = false;
                UI.scannerInput.placeholder = activeBox ? "Scan GKB Order # to Pack" : "Waiting for scan...";
                UI.scannerInput.focus();
            }
        };

        const packItem = async (orderNo) => {
            if (!activeBox) {
                showToast('Error: No active box. Scan a box ID first.', 'error'); return;
            }

            const order = activeBox.orders.find(o => o.gkb_order_no === orderNo);
            if (!order) {
                const { data: otherOrder } = await db.from('orders').select('*').eq('gkb_order_no', orderNo).single();
                if (otherOrder && otherOrder.status !== 'Packed') {
                    showExceptionModal(otherOrder, otherOrder.box_id);
                } else {
                    addLogEntry(`Scan failed: Order <strong class="font-mono">${orderNo}</strong> does not belong in this box.`, 'error');
                    showToast(`Error: Order "${orderNo}" does not belong in this box.`, 'error');
                }
                return;
            }

            if (order.status === 'Packed') { showToast(`Warning: Order "${orderNo}" is already packed.`, 'info'); return; }

            const { error } = await db.from('orders').update({ status: 'Packed', updated_by: currentUser.id }).eq('gkb_order_no', orderNo);
            
            if (error) { 
                showToast(`DB Error: ${error.message}`, 'error');
                console.error("DB Error on packItem:", error);
                return;
            }
            
            order.status = 'Packed';
            renderActiveBox();
            addLogEntry(`Order <strong class="font-mono">${orderNo}</strong> packed into <strong class="font-mono">${activeBox.box_id}</strong>.`);

            const packedCount = activeBox.orders.filter(o => o.status === 'Packed').length;
            if (packedCount === activeBox.orders.length) {
                await completeBox();
            }
        };

        const completeBox = async () => {
            const completedBoxId = activeBox.box_id;
            
            const { error } = await db.from('boxes').update({ status: 'Packed', updated_at: new Date().toISOString(), updated_by: currentUser.id }).eq('box_id', completedBoxId);

            if (error) {
                showToast(`Failed to complete box: ${error.message}`, 'error');
                console.error("DB Error on completeBox:", error);
                return; 
            }
            
            addLogEntry(`Box <strong class="font-mono">${completedBoxId}</strong> completed by ${currentUser.name}.`, 'success');
            showToast(`Box ${completedBoxId} complete!`, 'success', 5000);
            
            activeBox = null;
            dispatchQueue = dispatchQueue.filter(b => b.box_id !== completedBoxId);
            renderActiveBox();
            renderQueue();
        };

        const handleExceptionConfirm = async () => {
            const { order, originalBoxId } = exceptionContext;
            addLogEntry(`Moving <strong class="font-mono">${order.gkb_order_no}</strong> from <strong class="font-mono">${originalBoxId}</strong> to <strong class="font-mono">${activeBox.box_id}</strong>.`, 'info');
            
            const { error } = await db.from('orders').update({ box_id: activeBox.box_id, status: 'Packed', updated_by: currentUser.id }).eq('gkb_order_no', order.gkb_order_no);
            if (error) { 
                showToast('DB Error: Could not move order.', 'error'); 
                console.error("DB Error on exception confirm:", error);
                return; 
            }
            
            // Re-fetch the active box to get the new order
            await activateBox(activeBox.box_id);
            
            UI.exceptionModal.classList.remove('active');
            exceptionContext = null;
            showToast(`Order ${order.gkb_order_no} successfully moved to box ${activeBox.box_id}!`, 'success');
        };

        const handleScan = async (scannedValue) => {
            const value = scannedValue.trim();
            if (!value) return;
            UI.scannerInput.value = '';
            UI.scannerInput.focus();

            const isBoxInQueue = dispatchQueue.some(b => b.box_id === value);
            if (isBoxInQueue) {
                await activateBox(value);
            } else {
                await packItem(value);
            }
        };
        
        // --- RENDER FUNCTIONS ---
        const renderQueue = () => {
            UI.packingQueue.innerHTML = '';
            if (dispatchQueue.length === 0) {
                UI.queuePlaceholder.innerHTML = `<i class="ph-bold ph-stack text-6xl text-slate-400 mx-auto"></i><p class="mt-4 font-semibold text-slate-600">No boxes are pending for today.</p><p class="text-sm text-slate-400 mt-1">Create a dispatch plan to begin.</p>`;
                UI.packingQueue.appendChild(UI.queuePlaceholder);
                return;
            }
            
            dispatchQueue.forEach(box => {
                const div = document.createElement('div');
                const priorityClass = getCourierPriority(box.courier_name);
                const isActive = activeBox && box.box_id === activeBox.box_id;
                div.className = `queue-item p-4 rounded-lg shadow-sm transition-all cursor-pointer ${priorityClass} ${isActive ? 'active' : ''}`;
                div.dataset.boxId = box.box_id;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-sm font-mono">${box.box_id}</p>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${getPriorityClass(box.courier_name, true)}">${box.courier_name || 'N/A'}</span>
                    </div>
                    <p class="text-xs text-slate-600 mt-1">${box.store_name}</p>
                `;
                div.addEventListener('click', () => handleScan(box.box_id));
                UI.packingQueue.appendChild(div);
            });
        };
        
        const renderActiveBox = () => {
            if (!activeBox) {
                UI.activeBoxPlaceholder.classList.remove('hidden');
                UI.activeBoxDetails.classList.add('hidden');
                UI.scannerLabel.textContent = 'Scan Box ID to Activate';
                return;
            }

            UI.activeBoxPlaceholder.classList.add('hidden');
            UI.activeBoxDetails.classList.remove('hidden');
            UI.scannerLabel.textContent = 'Scan GKB Order # to Pack';

            UI.boxIdDisplay.textContent = activeBox.box_id;
            UI.storeInfoDisplay.textContent = `${activeBox.store_name} - ${activeBox.city}`;

            UI.pendingItems.innerHTML = '';
            UI.packedItems.innerHTML = '';
            const packedCount = activeBox.orders.filter(o => o.status === 'Packed').length;
            
            activeBox.orders.sort((a,b) => a.gkb_order_no.localeCompare(b.gkb_order_no)).forEach(order => {
                const li = document.createElement('li');
                li.className = `font-mono text-sm p-2 rounded-md flex justify-between items-center`;
                li.innerHTML = `<span>${order.gkb_order_no}</span><span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded">${order.store_code}</span>`;
                
                if (order.status === 'Packed') {
                    li.classList.add('packed-item');
                    UI.packedItems.prepend(li);
                } else {
                    li.classList.add('bg-slate-50', 'shadow-sm');
                    UI.pendingItems.appendChild(li);
                }
            });

            const totalCount = activeBox.orders.length;
            const percentage = totalCount > 0 ? (packedCount / totalCount) * 100 : 0;
            UI.progressText.textContent = `${packedCount} / ${totalCount}`;
            UI.progressBar.style.width = `${percentage}%`;
        };

        const getCourierPriority = (courierName) => {
            const name = (courierName || '').toLowerCase();
            if (name.includes('delivery boy')) return 1;
            if (name.includes('dtdc') || name.includes('bluedart')) return 2;
            return 3;
        };

        const getPriorityClass = (courierName, forBadge = false) => {
            const priority = getCourierPriority(courierName);
            if (forBadge) {
                if (priority === 1) return 'bg-yellow-400 text-yellow-900';
                if (priority === 2) return 'bg-orange-400 text-orange-900';
                return 'bg-slate-300 text-slate-700';
            }
            if (priority === 1) return 'priority-delivery-boy';
            if (priority === 2) return 'priority-urgent';
            return 'priority-normal';
        };

        // --- INITIALIZATION & USER SETUP ---
        const initializeApp = async () => {
            const { data: { session } } = await db.auth.getSession();
            if (!session) {
                redirectTo('login.html');
                return;
            }

            const { data: { user } } = await db.auth.getUser();
            const { data: userProfile, error } = await db.from('users').select('full_name, role').eq('id', user.id).single();
            
            if (error || !userProfile) {
                console.error("Could not fetch user profile:", error);
                currentUser = { id: user.id, name: user.email, role: 'packer' };
            } else {
                currentUser = { id: user.id, name: userProfile.full_name, role: userProfile.role };
            }

            UI.userDisplay.textContent = currentUser.name;
            UI.userRoleDisplay.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            UI.userInitials.textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            addLogEntry(`Application initialized for user <strong class="font-semibold">${currentUser.name}</strong>.`);
            
            fetchDispatchQueue();
            UI.scannerInput.focus();
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- EVENT LISTENERS ---
            UI.scannerInput.addEventListener('change', (e) => handleScan(e.target.value));
            UI.exceptionConfirmBtn.addEventListener('click', handleExceptionConfirm);
            UI.exceptionCancelBtn.addEventListener('click', () => UI.exceptionModal.classList.remove('active'));
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (UI.exceptionModal.classList.contains('active')) {
                        UI.exceptionModal.classList.remove('active');
                        exceptionContext = null;
                    } else if (activeBox) {
                        activeBox = null;
                        renderActiveBox();
                        renderQueue();
                        addLogEntry('Active box cleared.');
                    }
                }
            });
            UI.logoutBtn.addEventListener('click', async () => {
                await db.auth.signOut();
                redirectTo('login.html');
            });
            UI.sidebarToggle.addEventListener('click', () => {
                UI.sidebar.classList.toggle('collapsed');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-right');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-left');
            });
            UI.themeToggle.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            });

            // Start the application
            setTheme(localStorage.getItem('theme') || 'light');
            initializeApp();
        });
    </script>
</body>
</html>
