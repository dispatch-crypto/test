<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docket Generation - Smart Dispatch</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Helper Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <!-- Phosphor Icons for a clean, modern look -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        [data-theme="dark"] body {
            background-color: #1e293b;
            color: #f1f5f9;
        }
        .sidebar { transition: all 0.3s ease; width: 256px; }
        .sidebar.collapsed { width: 64px; }
        .sidebar-item-text { transition: all 0.3s ease; }
        .sidebar.collapsed .sidebar-item-text { opacity: 0; pointer-events: none; }
        .box-input-item {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .box-preview-item {
            transition: transform 0.2s ease;
        }
        .box-preview-item:hover {
            transform: scale(1.02);
        }
        .modal { display: none; }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .toast { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.hide { transform: translateY(100%); opacity: 0; }
        [data-theme="dark"] .bg-slate-50 { background-color: #475569; }
        [data-theme="dark"] .bg-white { background-color: #1f2a3a; color: #f1f5f9; }
        [data-theme="dark"] .bg-indigo-600 { background-color: #4f46e5; }
        [data-theme="dark"] .text-slate-800 { color: #f1f5f9; }
        [data-theme="dark"] .text-slate-900 { color: #e2e8f0; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-white shadow-xl p-4 flex flex-col justify-between">
            <div>
                <div class="flex items-center justify-between mb-8 p-2">
                    <a href="./index.html" class="flex items-center space-x-3">
                        <div class="bg-indigo-600 p-2 rounded-lg shadow">
                            <i class="ph-bold ph-list-dashes text-white text-lg"></i>
                        </div>
                        <span class="text-xl font-extrabold tracking-tight text-slate-900 sidebar-item-text">Smart Dispatch</span>
                    </a>
                    <button id="sidebar-toggle" class="p-1 rounded-md hover:bg-slate-100">
                        <i class="ph-bold ph-caret-left text-slate-400"></i>
                    </button>
                </div>
                <nav>
    <ul class="space-y-2">
        <li>
            <a href="./index.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-house-simple text-lg"></i>
                <span class="sidebar-item-text">Dashboard</span>
            </a>
        </li>
        <li>
            <a href="./daily_dispatch.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-cloud-arrow-up text-lg"></i>
                <span class="sidebar-item-text">Daily Dispatch</span>
            </a>
        </li>
        <li>
            <a href="./packing_station_final_working.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-package text-lg"></i>
                <span class="sidebar-item-text">Packing Station</span>
            </a>
        </li>
        <li>
            <a href="./shipment_management_final.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-truck text-lg"></i>
                <span class="sidebar-item-text">Shipments</span>
            </a>
        </li>
        <li>
            <a href="./docket_generation.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                <i class="ph-fill ph-file-text text-lg"></i>
                <span class="sidebar-item-text">Generate Dockets</span>
            </a>
        </li>
    </ul>
</nav>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-200 flex items-center justify-center">
                            <span class="font-bold text-indigo-800" id="user-initials"></span>
                        </div>
                        <div class="flex flex-col sidebar-item-text">
                            <span class="text-sm font-semibold text-slate-800" id="user-display">Loading...</span>
                            <span class="text-xs text-slate-500" id="user-role-display"></span>
                        </div>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-md hover:bg-slate-200">
                        <i class="ph-bold ph-sign-out text-slate-500 text-lg"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-3 p-2 rounded-lg bg-slate-50 justify-between">
                    <span class="text-xs font-semibold text-slate-600 sidebar-item-text">Dark Mode</span>
                    <button id="theme-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition-colors">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" id="theme-circle"></span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-6 lg:p-8">
            <h1 class="text-3xl font-extrabold text-slate-900 mb-8">Docket File Generation</h1>
            <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Left Section: Box Input -->
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Select Boxes</h2>
                        <div class="relative mb-4">
                            <i class="ph-bold ph-barcode text-lg absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="scan-input" placeholder="Scan or enter Box ID and press Enter" class="w-full pl-12 pr-4 py-3 text-lg font-semibold text-slate-800 bg-slate-50 rounded-lg border-2 border-slate-300 transition-all">
                        </div>
                        <div id="box-list-container" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                            <p id="box-list-placeholder" class="text-sm text-slate-500 text-center py-8">No boxes selected yet.</p>
                        </div>
                    </div>

                    <!-- Right Section: Preview & Generation -->
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 mb-4">File Preview & Download</h2>
                        <div id="preview-container" class="bg-slate-50 p-6 rounded-xl min-h-[300px] flex items-center justify-center">
                            <p id="preview-placeholder" class="text-sm text-slate-500 text-center">Select boxes to see a preview of the file.</p>
                        </div>
                        <div id="action-buttons" class="mt-6 flex flex-col space-y-4">
                            <button id="generate-bluedart-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-all shadow-lg flex items-center justify-center space-x-2" disabled>
                                <i class="ph-bold ph-file-csv text-lg"></i>
                                <span>Generate Blue Dart File</span>
                            </button>
                            <button id="generate-dtdc-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-all shadow-lg flex items-center justify-center space-x-2" disabled>
                                <i class="ph-bold ph-file-csv text-lg"></i>
                                <span>Generate DTDC File</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="h-12 w-12 border-4 border-indigo-500 border-t-transparent rounded-full spinner"></div>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-slate-700">Fetching data...</p>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script type="module">
        // --- CONFIGURATION ---
        const SUPABASE_URL = typeof __supabase_url !== 'undefined' ? __supabase_url : 'https://jyzbdkuizwvqamsxqdfg.supabase.co';
        const SUPABASE_ANON_KEY = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emJka3Vpend2cWFtc3hxZGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTE2MzUsImV4cCI6MjA2OTk4NzYzNX0.AqcKHtGPjm5fSijgjh8CMzrqRuheDRAefyU0prPwY2I';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let selectedBoxes = new Map();
        const today = new Date().toISOString().split('T')[0];
        const dateSuffix = `${String(new Date().getDate()).padStart(2, '0')}${String(new Date().getMonth() + 1).padStart(2, '0')}`;

        // --- UI ELEMENTS ---
        const UI = {
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            themeToggle: document.getElementById('theme-toggle'),
            themeCircle: document.getElementById('theme-circle'),
            userDisplay: document.getElementById('user-display'),
            userInitials: document.getElementById('user-initials'),
            userRoleDisplay: document.getElementById('user-role-display'),
            logoutBtn: document.getElementById('logout-btn'),
            scanInput: document.getElementById('scan-input'),
            boxListContainer: document.getElementById('box-list-container'),
            boxListPlaceholder: document.getElementById('box-list-placeholder'),
            previewContainer: document.getElementById('preview-container'),
            previewPlaceholder: document.getElementById('preview-placeholder'),
            actionButtons: document.getElementById('action-buttons'),
            bluedartButton: document.getElementById('generate-bluedart-btn'),
            dtdcButton: document.getElementById('generate-dtdc-btn'),
            toastContainer: document.getElementById('toast-container'),
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),
        };

        // --- UTILITY FUNCTIONS ---
        const redirectTo = (page) => {
            const currentPath = window.location.pathname;
            const newPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1) + page;
            window.location.href = new URL(newPath, window.location.origin).href;
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            let bgColor = 'bg-slate-800';
            let icon = `<i class="ph-bold ph-info text-white"></i>`;
            if (type === 'success') {
                bgColor = 'bg-emerald-600';
                icon = `<i class="ph-bold ph-check-circle text-white"></i>`;
            } else if (type === 'error') {
                bgColor = 'bg-rose-600';
                icon = `<i class="ph-bold ph-x-circle text-white"></i>`;
            }

            toast.className = `toast px-4 py-3 rounded-lg text-white shadow-lg flex items-center space-x-3 transform translate-y-full opacity-0 ${bgColor}`;
            toast.innerHTML = `${icon} <span class="font-semibold text-sm">${message}</span>`;
            UI.toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        };
        
        const setTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                UI.themeCircle.style.transform = 'translateX(20px)';
                UI.themeCircle.style.backgroundColor = '#64748b';
            } else {
                UI.themeCircle.style.transform = 'translateX(0)';
                UI.themeCircle.style.backgroundColor = '#fff';
            }
        };

        const showLoading = (show, text = 'Fetching data...') => {
            UI.loadingText.textContent = text;
            UI.loadingOverlay.classList.toggle('hidden', !show);
        };

        // --- AUTHENTICATION & UI SETUP ---
        const initializeAuth = async () => {
            const { data: { session } } = await db.auth.getSession();
            if (!session) {
                redirectTo('login.html');
                return;
            }

            const { data: { user } } = await db.auth.getUser();
            const { data: userProfile, error } = await db.from('users').select('full_name, role').eq('id', user.id).single();
            
            if (error) {
                console.error("Could not fetch user profile:", error);
                currentUser = { id: user.id, name: user.email, role: 'packer' };
            } else {
                currentUser = { id: user.id, name: userProfile.full_name, role: userProfile.role };
            }
            
            UI.userDisplay.textContent = currentUser.name;
            UI.userRoleDisplay.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            UI.userInitials.textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
        };

        // --- CORE LOGIC ---
        const fetchBoxData = async (boxId) => {
            showLoading(true);
            try {
                const { data, error } = await db.from('boxes')
                    .select(`
                        box_id,
                        status,
                        orders(gkb_order_no, customer_ref),
                        delivery_groups(full_address, pincode, stores(store_name, mobile, couriers(name)))
                    `)
                    .eq('box_id', boxId)
                    .single();

                if (error || !data) {
                    showToast(`Error: Box ID "${boxId}" not found.`, 'error');
                    return null;
                }

                if (data.status !== 'Packed') {
                    showToast(`Warning: Box "${boxId}" is not yet packed.`, 'info');
                }

                return data;
            } catch (err) {
                showToast('An unexpected error occurred while fetching box data.', 'error');
                return null;
            } finally {
                showLoading(false);
            }
        };

        const handleScan = async (boxId) => {
            if (selectedBoxes.has(boxId)) {
                showToast(`Box ${boxId} is already in the list.`, 'info');
                return;
            }

            const boxData = await fetchBoxData(boxId);
            if (boxData) {
                selectedBoxes.set(boxId, boxData);
                renderBoxList();
                renderPreview();
                showToast(`Box ${boxId} added.`, 'success');
            }
        };

        const removeBox = (boxId) => {
            selectedBoxes.delete(boxId);
            renderBoxList();
            renderPreview();
            showToast(`Box ${boxId} removed.`, 'info');
        };

        const generateAndDownloadCSV = (courier) => {
            let csvData = [];
            let filename = '';
            
            if (courier.toLowerCase().includes('bluedart')) {
                 const headers = ["Reference No *", "Billing Area *", "Billing Customer Code *", "Pickup Date *", "Pickup Time *", "Shipper Name *", "Pickup address *", "Pickup pincode *", "Company Name", "Delivery address *", "Delivery Pincode *", "Product Code *", "Product Type *", "Pack Type", "Piece Count *", "Actual Weight *", "Declared Value *", "Register Pickup *", "Length", "Breadth", "Height", "To Pay Customer", "Sender", "Sender mobile", "Receiver Telephone", "Receiver mobile", "Receiver Name", "Special Instruction", "Commodity Detail 1", "Commodity Detail 2", "Commodity Detail 3", "Reference No 2", "Reference No 3", "OTP Based Delivery", "Office Closure time", "AWB No", "Status", "Message", "Cluster Code", "Destination Area", "Destination Location", "Pick Up Token No", "Response pick up date", "Transaction Amount", "Wallet Balance", "Available Booking Amount"];
                 csvData.push(headers);
                 
                 selectedBoxes.forEach(box => {
                    const store = box.delivery_groups.stores[0];
                    const deliveryAddress = box.delivery_groups.full_address;
                    const row = [
                        box.box_id, // Reference No *
                        "NDA", // Billing Area *
                        "991712", // Billing Customer Code *
                        today, // Pickup Date *
                        "1930", // Pickup Time *
                        "GKB EYECARE", // Shipper Name *
                        "B 48 GKB EYECARE", // Pickup address *
                        "201305", // Pickup pincode *
                        "BEN FRANKLIN OPTICIAN", // Company Name
                        `"${deliveryAddress}"`, // Delivery address *
                        box.delivery_groups.pincode, // Delivery Pincode *
                        "D", // Product Code *
                        "NDOX", // Product Type *
                        "", // Pack Type
                        1, // Piece Count *
                        0.5, // Actual Weight *
                        500, // Declared Value *
                        "TRUE", // Register Pickup *
                        "", "", "", "", // Length, Breadth, Height, To Pay Customer
                        "GKB EYECARE", // Sender
                        "9289012244", // Sender mobile
                        "", // Receiver Telephone
                        store.mobile, // Receiver mobile
                        store.store_name, // Receiver Name
                        "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""
                    ];
                    csvData.push(row);
                });
                filename = `Bluedart_Upload_${today}.csv`;

            } else if (courier.toLowerCase().includes('dtdc')) {
                const headers = ["Consignment Number", "Customer Reference Number", "Declared Price (non-document)", "Number of Pieces (non-document)", "Weight(KG) (non-document)", "Destination Pincode", "Destination Name", "Destination Phone", "Destination Address Line 1"];
                csvData.push(headers);
                
                selectedBoxes.forEach(box => {
                    const store = box.delivery_groups.stores[0];
                    const deliveryAddress = box.delivery_groups.full_address;
                    const row = [
                        "", // Consignment Number (left blank for generation)
                        box.box_id, // Customer Reference Number
                        "499", // Declared Price
                        1, // Number of Pieces
                        0.5, // Weight(KG)
                        box.delivery_groups.pincode, // Destination Pincode
                        "BEN FRANKLIN OPTICIAN", // Destination Name
                        store.mobile, // Destination Phone
                        `"${deliveryAddress}"`, // Destination Address Line 1
                    ];
                    csvData.push(row);
                });
                filename = `DTDC_Upload_${today}.csv`;
            }

            if (csvData.length > 0) {
                const csvString = Papa.unparse(csvData);
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                link.remove();
                showToast('File generated and downloaded successfully!', 'success');
            } else {
                showToast('No data to generate file.', 'error');
            }
        };

        // --- RENDER FUNCTIONS ---
        const renderBoxList = () => {
            UI.boxListContainer.innerHTML = '';
            if (selectedBoxes.size === 0) {
                UI.boxListContainer.appendChild(UI.boxListPlaceholder);
            } else {
                selectedBoxes.forEach((box, boxId) => {
                    const item = document.createElement('div');
                    item.className = 'box-input-item bg-slate-200 text-slate-800 rounded-lg px-3 py-1 flex items-center justify-between';
                    item.innerHTML = `
                        <span class="font-mono text-sm">${boxId}</span>
                        <button class="remove-btn p-1 ml-2 text-slate-500 hover:text-rose-600" data-box-id="${boxId}">
                            <i class="ph-bold ph-x text-xs"></i>
                        </button>
                    `;
                    item.querySelector('.remove-btn').addEventListener('click', () => removeBox(boxId));
                    UI.boxListContainer.appendChild(item);
                });
            }
        };

        const renderPreview = () => {
            UI.previewContainer.innerHTML = '';
            
            if (selectedBoxes.size === 0) {
                UI.previewContainer.appendChild(UI.previewPlaceholder);
                UI.bluedartButton.disabled = true;
                UI.dtdcButton.disabled = true;
                return;
            }

            const boxesArray = Array.from(selectedBoxes.values());
            const firstCourier = boxesArray[0].delivery_groups.stores[0].couriers.name;
            const isCourierConsistent = boxesArray.every(b => b.delivery_groups.stores[0].couriers.name === firstCourier);

            if (!isCourierConsistent) {
                UI.previewContainer.innerHTML = `
                    <div class="text-center p-8 text-rose-600">
                        <i class="ph-bold ph-warning-circle text-4xl mx-auto mb-2"></i>
                        <p class="font-semibold">Mixed Couriers Detected!</p>
                        <p class="text-sm text-slate-500">Please select boxes for only one courier at a time.</p>
                    </div>
                `;
                UI.bluedartButton.disabled = true;
                UI.dtdcButton.disabled = true;
                return;
            }

            const previewTable = document.createElement('table');
            previewTable.className = 'w-full text-left text-sm table-auto';
            previewTable.innerHTML = `
                <thead>
                    <tr class="border-b-2 border-slate-300">
                        <th class="p-2">Box ID</th>
                        <th class="p-2">Courier</th>
                        <th class="p-2">Orders</th>
                    </tr>
                </thead>
                <tbody>
                    ${boxesArray.map(box => `
                        <tr class="box-preview-item border-b border-slate-200 hover:bg-slate-100">
                            <td class="p-2 font-mono text-xs">${box.box_id}</td>
                            <td class="p-2">${box.delivery_groups.stores[0].couriers.name}</td>
                            <td class="p-2">${box.orders.length}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            UI.previewContainer.appendChild(previewTable);
            
            UI.actionButtons.classList.remove('hidden');
            
            if (firstCourier.toLowerCase().includes('bluedart')) {
                UI.bluedartButton.disabled = false;
                UI.dtdcButton.disabled = true;
            } else if (firstCourier.toLowerCase().includes('dtdc')) {
                UI.bluedartButton.disabled = true;
                UI.dtdcButton.disabled = false;
            } else {
                 UI.bluedartButton.disabled = true;
                 UI.dtdcButton.disabled = true;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- EVENT LISTENERS ---
            UI.sidebarToggle.addEventListener('click', () => {
                UI.sidebar.classList.toggle('collapsed');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-right');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-left');
            });
            UI.themeToggle.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            });
            UI.logoutBtn.addEventListener('click', async () => {
                await db.auth.signOut();
                redirectTo('login.html');
            });

            UI.scanInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const boxId = e.target.value.trim();
                    if (boxId) {
                        handleScan(boxId);
                        e.target.value = '';
                    }
                }
            });

            UI.bluedartButton.addEventListener('click', () => generateAndDownloadCSV('bluedart'));
            UI.dtdcButton.addEventListener('click', () => generateAndDownloadCSV('dtdc'));

            // --- INITIALIZATION ---
            setTheme(localStorage.getItem('theme') || 'light');
            initializeAuth();
        });
    </script>
</body>
</html>
