<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Dispatch - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Phosphor Icons for a clean, modern look -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        [data-theme="dark"] body {
            background-color: #1e293b;
            color: #f1f5f9;
        }
        .sidebar { transition: all 0.3s ease; width: 256px; }
        .sidebar.collapsed { width: 64px; }
        .sidebar-item-text { transition: all 0.3s ease; }
        .sidebar.collapsed .sidebar-item-text { opacity: 0; pointer-events: none; }
        .dashboard-card { transition: all 0.2s ease-in-out; }
        .dashboard-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        [data-theme="dark"] .dashboard-card { background-color: #334155; color: #f1f5f9; border-color: #475569; }
        .realtime-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0.7; } }
        .toast { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.hide { transform: translateY(100%); opacity: 0; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .quick-action-btn { transition: all 0.2s ease-in-out; }
        .quick-action-btn:hover { transform: translateY(-2px); }
        [data-theme="dark"] .bg-slate-50 { background-color: #475569; }
        .modal { display: none; }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-white shadow-xl p-4 flex flex-col justify-between">
            <div>
                <div class="flex items-center justify-between mb-8 p-2">
                    <a href="./index.html" class="flex items-center space-x-3">
                        <div class="bg-indigo-600 p-2 rounded-lg shadow">
                            <i class="ph-bold ph-list-dashes text-white text-lg"></i>
                        </div>
                        <span class="text-xl font-extrabold tracking-tight text-slate-900 sidebar-item-text">Smart Dispatch</span>
                    </a>
                    <button id="sidebar-toggle" class="p-1 rounded-md hover:bg-slate-100">
                        <i class="ph-bold ph-caret-left text-slate-400"></i>
                    </button>
                </div>
                <nav>
                    <ul class="space-y-2">
                        <li>
                            <a href="./index.html" class="flex items-center space-x-3 p-3 rounded-lg text-indigo-700 bg-slate-100 font-semibold">
                                <i class="ph-fill ph-house-simple text-lg"></i>
                                <span class="sidebar-item-text">Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="./daily_dispatch.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                                <i class="ph-fill ph-cloud-arrow-up text-lg"></i>
                                <span class="sidebar-item-text">Daily Dispatch</span>
                            </a>
                        </li>
                        <li>
                            <a href="./packing_station_final_working.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                                <i class="ph-fill ph-package text-lg"></i>
                                <span class="sidebar-item-text">Packing Station</span>
                            </a>
                        </li>
                        <li>
                            <a href="./shipment_management_final.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                                <i class="ph-fill ph-truck text-lg"></i>
                                <span class="sidebar-item-text">Shipments</span>
                            </a>
                        </li>
                        <li>
                            <a href="./docket_generation.html" class="flex items-center space-x-3 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold">
                                <i class="ph-fill ph-file-text text-lg"></i>
                                <span class="sidebar-item-text">Generate Dockets</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-200 flex items-center justify-center">
                            <span class="font-bold text-indigo-800" id="user-initials"></span>
                        </div>
                        <div class="flex flex-col sidebar-item-text">
                            <span class="text-sm font-semibold text-slate-800" id="user-display">Loading...</span>
                            <span class="text-xs text-slate-500" id="user-role-display"></span>
                        </div>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-md hover:bg-slate-200">
                        <i class="ph-bold ph-sign-out text-slate-500 text-lg"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-3 p-2 rounded-lg bg-slate-50 justify-between">
                    <span class="text-xs font-semibold text-slate-600 sidebar-item-text">Dark Mode</span>
                    <button id="theme-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition-colors">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" id="theme-circle"></span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 lg:p-8 overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-extrabold text-slate-900">Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <button id="ai-summary-btn" class="quick-action-btn flex items-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700">
                        <i class="ph-bold ph-sparkle text-lg mr-2"></i>
                        <span>AI Daily Summary</span>
                    </button>
                    <div class="flex items-center space-x-2 text-sm text-slate-500 font-medium">
                        <span id="realtime-status" class="live-dot"></span>
                        <span>Real-time</span>
                    </div>
                </div>
            </div>

            <!-- Date & Quick Stats -->
            <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-800">Today's Overview</h2>
                    <input type="date" id="date-filter" class="p-2 border border-slate-300 rounded-lg shadow-sm">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <a href="./daily_dispatch.html" class="dashboard-card p-6 bg-slate-50 rounded-xl border border-slate-200">
                        <p class="text-sm font-medium text-slate-500">Total Orders</p>
                        <p id="kpi-total-orders" class="text-4xl font-extrabold text-slate-800 mt-1">...</p>
                    </a>
                    <a href="./packing_station_final_working.html" class="dashboard-card p-6 bg-slate-50 rounded-xl border border-slate-200">
                        <p class="text-sm font-medium text-slate-500">Boxes Pending</p>
                        <p id="kpi-boxes-pending" class="text-4xl font-extrabold text-amber-500 mt-1">...</p>
                    </a>
                    <a href="./shipment_management_final.html" class="dashboard-card p-6 bg-slate-50 rounded-xl border border-slate-200">
                        <p class="text-sm font-medium text-slate-500">Shipments Created</p>
                        <p id="kpi-shipments" class="text-4xl font-extrabold text-emerald-600 mt-1">...</p>
                    </a>
                     <a href="./packing_station_final_working.html" class="dashboard-card p-6 bg-indigo-600 rounded-xl border border-indigo-700 text-white">
                        <p class="text-sm font-medium text-indigo-200">My Packed Boxes</p>
                        <p id="kpi-my-packed-boxes" class="text-4xl font-extrabold mt-1">...</p>
                    </a>
                </div>
            </section>

            <!-- Main Panels -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Proactive Alerts & Predictive Analytics -->
                <section class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-lg font-bold text-slate-800 mb-4">Proactive Alerts</h2>
                            <div id="alerts-container" class="space-y-4">
                                <p id="no-alerts" class="text-sm text-slate-500 text-center py-8">No current alerts or issues found.</p>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-800 mb-4">Packing Progress & Forecast</h2>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-slate-700">Total Boxes</span>
                                    <span id="forecast-total-boxes" class="font-bold text-indigo-600">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-slate-700">Boxes Remaining</span>
                                    <span id="forecast-pending-boxes" class="font-bold text-amber-500">0</span>
                                </div>
                                <div class="flex items-center justify-between border-t mt-4 pt-4">
                                    <span class="text-lg font-bold text-slate-800">Estimated Completion</span>
                                    <span id="completion-forecast" class="text-lg font-extrabold text-emerald-600">N/A</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Order and Shipment Search -->
                <aside class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg border border-slate-200 flex flex-col">
                    <h2 class="text-lg font-bold text-slate-800 mb-4">Order & Shipment Search</h2>
                    <div class="relative mb-4">
                        <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="search-input" placeholder="Search by Order # or Box ID..." class="w-full pl-12 pr-4 py-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div id="search-results" class="space-y-4 flex-1 overflow-y-auto">
                        <p class="text-sm text-slate-500 text-center py-8">Search for an order or box to see its status.</p>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <!-- AI Summary Modal -->
    <div id="ai-summary-modal" class="modal fixed inset-0 bg-black/60 z-30 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl leading-6 font-bold text-slate-900 flex items-center"><i class="ph-bold ph-sparkle text-2xl mr-2"></i>AI Daily Summary</h3>
                <button id="close-ai-modal-btn" class="p-1 rounded-full hover:bg-slate-100">&times;</button>
            </div>
            <div id="ai-summary-content" class="mt-4 text-slate-600 bg-slate-50 p-4 rounded-lg min-h-[100px]">
                <div class="h-6 w-6 spinner border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script type="module">
        // --- CONFIGURATION ---
        const SUPABASE_URL = typeof __supabase_url !== 'undefined' ? __supabase_url : 'https://jyzbdkuizwvqamsxqdfg.supabase.co';
        const SUPABASE_ANON_KEY = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5emJka3Vpend2cWFtc3hxZGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MTE2MzUsImV4cCI6MjA2OTk4NzYzNX0.AqcKHtGPjm5fSijgjh8CMzrqRuheDRAefyU0prPwY2I';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- STATE & CHART MANAGEMENT ---
        let currentUser = null;
        let dashboardStats = {};
        let allOrders = [];
        let allBoxes = [];
        let allShipments = [];
        let selectedDate = new Date().toISOString().split('T')[0];

        // --- UTILITY FUNCTIONS ---
        const redirectTo = (page) => {
            const currentPath = window.location.pathname;
            const newPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1) + page;
            window.location.href = new URL(newPath, window.location.origin).href;
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            let bgColor = 'bg-slate-800';
            let icon = `<i class="ph-bold ph-info text-white"></i>`;
            if (type === 'success') {
                bgColor = 'bg-emerald-600';
                icon = `<i class="ph-bold ph-check-circle text-white"></i>`;
            } else if (type === 'error') {
                bgColor = 'bg-rose-600';
                icon = `<i class="ph-bold ph-x-circle text-white"></i>`;
            }

            toast.className = `toast px-4 py-3 rounded-lg text-white shadow-lg flex items-center space-x-3 transform translate-y-full opacity-0 ${bgColor}`;
            toast.innerHTML = `${icon} <span class="font-semibold text-sm">${message}</span>`;
            document.getElementById('toast-container').appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        };
        
        const setTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const themeCircle = document.getElementById('theme-circle');
            if (theme === 'dark') {
                themeCircle.style.transform = 'translateX(20px)';
                themeCircle.style.backgroundColor = '#64748b';
            } else {
                themeCircle.style.transform = 'translateX(0)';
                themeCircle.style.backgroundColor = '#fff';
            }
        };

        // --- UI ELEMENTS ---
        const UI = {
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            themeToggle: document.getElementById('theme-toggle'),
            themeCircle: document.getElementById('theme-circle'),
            userDisplay: document.getElementById('user-display'),
            userInitials: document.getElementById('user-initials'),
            userRoleDisplay: document.getElementById('user-role-display'),
            logoutBtn: document.getElementById('logout-btn'),
            aiSummaryBtn: document.getElementById('ai-summary-btn'),
            aiSummaryModal: document.getElementById('ai-summary-modal'),
            closeAiModalBtn: document.getElementById('close-ai-modal-btn'),
            aiSummaryContent: document.getElementById('ai-summary-content'),
            dateFilter: document.getElementById('date-filter'),
            kpiTotalOrders: document.getElementById('kpi-total-orders'),
            kpiBoxesPending: document.getElementById('kpi-boxes-pending'),
            kpiShipments: document.getElementById('kpi-shipments'),
            kpiMyPackedBoxes: document.getElementById('kpi-my-packed-boxes'),
            alertsContainer: document.getElementById('alerts-container'),
            noAlertsPlaceholder: document.getElementById('no-alerts'),
            forecastTotalBoxes: document.getElementById('forecast-total-boxes'),
            forecastPendingBoxes: document.getElementById('forecast-pending-boxes'),
            completionForecast: document.getElementById('completion-forecast'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
        };

        // --- AUTHENTICATION ---
        const initializeAuth = async () => {
            const { data: { session } } = await db.auth.getSession();
            if (!session) {
                redirectTo('login.html');
                return;
            }

            const { data: { user } } = await db.auth.getUser();
            const { data: userProfile, error } = await db.from('users').select('full_name, role').eq('id', user.id).single();
            
            if (error) {
                console.error("Could not fetch user profile:", error);
                currentUser = { id: user.id, name: user.email, role: 'packer' };
            } else {
                currentUser = { id: user.id, name: userProfile.full_name, role: userProfile.role };
            }
            
            UI.userDisplay.textContent = currentUser.name;
            UI.userRoleDisplay.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            UI.userInitials.textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            setupRoleBasedUI();
            await fetchDashboardData(selectedDate);
            initializeRealtime();
        };

        const setupRoleBasedUI = () => {
            if (currentUser.role !== 'manager') {
                const aiButton = document.getElementById('ai-summary-btn');
                if (aiButton) aiButton.remove();
            }
        };

        // --- DATA FETCHING AND RENDERING ---
        const fetchDashboardData = async (date) => {
            try {
                const [
                    { count: totalOrders, data: orders },
                    { data: boxes },
                    { data: shipments },
                    { data: issueAlerts },
                    { data: myPackedBoxesData },
                ] = await Promise.all([
                    db.from('orders').select('*', { count: 'exact' }).eq('order_date', date),
                    db.from('boxes').select('box_id, status, updated_by, updated_at, orders(gkb_order_no), delivery_groups(stores(courier_id, couriers(name))))').eq('dispatch_date', date),
                    db.from('shipments').select('docket_number, couriers(name), shipment_items(box_id)').eq('shipment_date', date),
                    db.from('delivery_confirmations').select('shipments(docket_number)').eq('status', 'Issue Reported').order('created_at', { ascending: false }),
                    db.from('boxes').select('*').eq('updated_by', currentUser.id).eq('dispatch_date', date).eq('status', 'Packed'),
                ]);

                allOrders = orders || [];
                allBoxes = boxes || [];
                allShipments = shipments || [];
                
                const myPackedBoxes = (myPackedBoxesData || []).length;
                
                dashboardStats = {
                    totalOrders: totalOrders || 0,
                    pending: (boxes || []).filter(b => b.status !== 'Packed').length,
                    shipped: (shipments || []).length,
                    myPackedBoxes: myPackedBoxes,
                    issueAlerts: issueAlerts.map(a => a.shipments).filter(Boolean),
                    totalBoxes: (boxes || []).length,
                    dayStartTime: new Date(date).setHours(9, 0, 0, 0),
                    packingVelocity: (boxes || [])
                        .filter(b => b.status === 'Packed')
                        .reduce((acc, box) => {
                            const hour = new Date(box.updated_at).getHours();
                            acc[hour] = (acc[hour] || 0) + 1;
                            return acc;
                        }, {}),
                };
                
                const courierCounts = (shipments || []).reduce((acc, s) => {
                    const courierName = s.couriers ? s.couriers.name : 'Unknown';
                    acc[courierName] = (acc[courierName] || 0) + s.shipment_items.length;
                    return acc;
                }, {});

                renderKPIs(dashboardStats);
                renderAlertsAndForecast();
                showToast('Dashboard data updated.', 'success');

            } catch (error) {
                console.error("Dashboard Error:", error);
                showToast('Failed to fetch dashboard data.', 'error');
            }
        };

        const initializeRealtime = () => {
            const channel = db.channel('realtime-dashboard');
            channel
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'delivery_confirmations' }, payload => {
                    fetchDashboardData(selectedDate);
                    showToast('A new delivery issue has been reported!', 'error');
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'boxes' }, () => {
                    fetchDashboardData(selectedDate);
                    showToast('Box status updated.', 'info');
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'shipments' }, () => {
                    fetchDashboardData(selectedDate);
                    showToast('A new shipment has been created.', 'info');
                })
                .subscribe();
        };

        const renderKPIs = (stats) => {
            UI.kpiTotalOrders.textContent = stats.totalOrders || 0;
            UI.kpiBoxesPending.textContent = stats.pending || 0;
            UI.kpiShipments.textContent = stats.shipped || 0;
            UI.kpiMyPackedBoxes.textContent = stats.myPackedBoxes || 0;
        };

        const renderAlertsAndForecast = () => {
            UI.alertsContainer.innerHTML = '';
            
            const issueAlerts = dashboardStats.issueAlerts || [];
            if (issueAlerts.length > 0) {
                UI.noAlertsPlaceholder.classList.add('hidden');
                issueAlerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'flex items-center space-x-3 p-3 bg-rose-50 rounded-lg shadow-sm border border-rose-200';
                    alertDiv.innerHTML = `
                        <i class="ph-bold ph-warning text-lg text-rose-600 flex-shrink-0"></i>
                        <p class="text-sm text-slate-800">
                            Delivery issue reported for shipment <strong class="font-semibold">${alert.docket_number}</strong>.
                        </p>
                    `;
                    UI.alertsContainer.appendChild(alertDiv);
                });
            } else {
                 UI.noAlertsPlaceholder.classList.remove('hidden');
            }

            const boxesPacked = dashboardStats.totalBoxes - dashboardStats.pending;
            const totalPackingTime = (new Date() - dashboardStats.dayStartTime) / 1000 / 60;
            const avgTimePerBox = boxesPacked > 0 ? totalPackingTime / boxesPacked : 0;
            const remainingTimeInMinutes = avgTimePerBox * dashboardStats.pending;

            UI.forecastTotalBoxes.textContent = dashboardStats.totalBoxes;
            UI.forecastPendingBoxes.textContent = dashboardStats.pending;
            
            if (dashboardStats.pending === 0) {
                UI.completionForecast.textContent = 'Completed!';
                UI.completionForecast.classList.replace('text-amber-600', 'text-emerald-600');
            } else if (avgTimePerBox > 0) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + remainingTimeInMinutes);
                UI.completionForecast.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                UI.completionForecast.classList.replace('text-emerald-600', 'text-amber-600');
            } else {
                UI.completionForecast.textContent = 'N/A';
                UI.completionForecast.classList.replace('text-emerald-600', 'text-amber-600');
            }
        };

        const renderSearchResults = (results) => {
            UI.searchResults.innerHTML = '';
            if (results.length === 0) {
                UI.searchResults.innerHTML = `<p class="text-sm text-slate-500 text-center py-8">No results found.</p>`;
                return;
            }
            results.forEach(item => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'p-4 bg-slate-50 rounded-lg shadow-sm border border-slate-200';
                if (item.type === 'box') {
                    const shipment = allShipments.find(s => s.shipment_items.some(si => si.box_id === item.box_id));
                    resultDiv.innerHTML = `
                        <p class="font-bold text-slate-800 flex items-center space-x-2">
                            <i class="ph-bold ph-package text-lg"></i>
                            <span class="font-mono">${item.box_id}</span>
                        </p>
                        <p class="text-sm text-slate-600 mt-1">Status: <span class="font-semibold">${item.status}</span></p>
                        ${shipment ? `<p class="text-sm text-slate-600">Shipped with: <span class="font-semibold">${shipment.docket_number} (${shipment.couriers.name})</span></p>` : `<p class="text-sm text-slate-600">Not yet shipped</p>`}
                    `;
                } else if (item.type === 'order') {
                    const box = allBoxes.find(b => b.orders.some(o => o.gkb_order_no === item.gkb_order_no));
                    resultDiv.innerHTML = `
                        <p class="font-bold text-slate-800 flex items-center space-x-2">
                            <i class="ph-bold ph-tag text-lg"></i>
                            <span class="font-mono">${item.gkb_order_no}</span>
                        </p>
                        <p class="text-sm text-slate-600 mt-1">Status: <span class="font-semibold">${item.status}</span></p>
                        ${box ? `<p class="text-sm text-slate-600">In Box: <span class="font-semibold font-mono">${box.box_id}</span></p>` : `<p class="text-sm text-slate-600">Not assigned to a box</p>`}
                    `;
                }
                UI.searchResults.appendChild(resultDiv);
            });
        };

        const getAiSummary = async () => {
            UI.aiSummaryContent.innerHTML = '<div class="h-6 w-6 spinner border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>';
            UI.aiSummaryModal.classList.add('active');
            
            const pendingBoxes = dashboardStats.pending || 0;
            const shippedBoxes = dashboardStats.shipped || 0;
            const totalOrders = dashboardStats.totalOrders || 0;
            const myContribution = dashboardStats.myPackedBoxes || 0;

            const prompt = `
                You are an operations manager for a lens dispatch center. 
                Write a brief, encouraging, and professional summary of today's progress. Be concise and use a positive tone.
                Based on the following data:
                - Total orders processed: ${totalOrders}
                - Boxes currently pending/in-progress: ${pendingBoxes}
                - Total shipments created: ${shippedBoxes}
                - My personal contribution (boxes packed): ${myContribution}
                
                Start with a positive opening, mention the overall progress, highlight the personal contribution, and end with a motivational closing statement.
            `;

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                UI.aiSummaryContent.textContent = text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                UI.aiSummaryContent.textContent = "Could not generate summary. Please try again later.";
            }
        };

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            UI.sidebarToggle.addEventListener('click', () => {
                UI.sidebar.classList.toggle('collapsed');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-right');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-left');
            });
            UI.themeToggle.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            });
            UI.logoutBtn.addEventListener('click', async () => {
                await db.auth.signOut();
                redirectTo('login.html');
            });
            UI.aiSummaryBtn.addEventListener('click', getAiSummary);
            UI.closeAiModalBtn.addEventListener('click', () => UI.aiSummaryModal.classList.remove('active'));
            UI.dateFilter.addEventListener('change', (e) => {
                selectedDate = e.target.value;
                fetchDashboardData(selectedDate);
            });
            UI.searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.length > 2) {
                    const results = [...allOrders.filter(o => o.gkb_order_no.toLowerCase().includes(searchTerm) || o.customer_ref.toLowerCase().includes(searchTerm)).map(o => ({...o, type: 'order'})),
                                     ...allBoxes.filter(b => b.box_id.toLowerCase().includes(searchTerm)).map(b => ({...b, type: 'box'}))];
                    renderSearchResults(results);
                } else {
                    UI.searchResults.innerHTML = `<p class="text-sm text-slate-500 text-center py-8">Search for an order or box to see its status.</p>`;
                }
            });
            
            // --- INITIALIZATION ---
            UI.dateFilter.value = selectedDate;
            setTheme(localStorage.getItem('theme') || 'light');
            initializeAuth();
        });
    </script>
</body>
</html>
